<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1">



<title>Ingesting Data</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>



<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#header {
text-align: center;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; }  code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Ingesting Data</h1>



<p>Let’s set-up <code>disk.frame</code></p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" title="1"><span class="kw">library</span>(disk.frame)</a>
<a class="sourceLine" id="cb1-2" title="2"></a>
<a class="sourceLine" id="cb1-3" title="3"><span class="co"># set-up disk.frame to use multiple workers</span></a>
<a class="sourceLine" id="cb1-4" title="4"><span class="cf">if</span>(<span class="kw">interactive</span>()) {</a>
<a class="sourceLine" id="cb1-5" title="5">  <span class="kw">setup_disk.frame</span>()</a>
<a class="sourceLine" id="cb1-6" title="6">  <span class="co"># highly recommended, however it is pun into interactive() for CRAN because</span></a>
<a class="sourceLine" id="cb1-7" title="7">  <span class="co"># change user options are not allowed on CRAN</span></a>
<a class="sourceLine" id="cb1-8" title="8">  <span class="kw">options</span>(<span class="dt">future.globals.maxSize =</span> <span class="ot">Inf</span>)  </a>
<a class="sourceLine" id="cb1-9" title="9">} <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb1-10" title="10">  <span class="kw">setup_disk.frame</span>(<span class="dv">2</span>)</a>
<a class="sourceLine" id="cb1-11" title="11">}</a></code></pre></div>
<p>One of the most important tasks to perform before using the <code>disk.frame</code> package is to make some <code>disk.frame</code>s! There are a few functions to help you do that.</p>
<div id="convert-a-data.frame-to-disk.frame" class="section level2">
<h2>Convert a <code>data.frame</code> to <code>disk.frame</code></h2>
<p>Firstly there is <code>as.disk.frame()</code> which allows you to make a <code>disk.frame</code> from a <code>data.frame</code>, e.g.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" title="1">flights.df =<span class="st"> </span><span class="kw">as.disk.frame</span>(nycflights13<span class="op">::</span>flights)</a></code></pre></div>
<p>will convert the <code>nycflights13::flights</code> <code>data.frame</code> to a <code>disk.frame</code> somewhere in <code>tempdir()</code>. To find out the location of the <code>disk.frame</code> use:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" title="1"><span class="kw">attr</span>(flights.df, <span class="st">&quot;path&quot;</span>)</a></code></pre></div>
<p>You can also specify a location to output the <code>disk.frame</code> to using <code>outdir</code></p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" title="1">flights.df =<span class="st"> </span><span class="kw">as.disk.frame</span>(nycflights13<span class="op">::</span>flights, <span class="dt">outdir =</span> <span class="st">&quot;some/path.df&quot;</span>)</a></code></pre></div>
<p>it is recommended that you use <code>.df</code> as the extension for a <code>disk.frame</code>, however this is not an enforced requirement.</p>
<p>However, one of the reasons for <code>disk.frame</code> to exist is to handle larger-than-RAM files, hence <code>as.disk.frame</code> is not all that useful because it can only convert data that can fit into RAM. <code>disk.frame</code> comes with a couple more ways to create <code>disk.frame</code>.</p>
</div>
<div id="creating-disk.frame-from-csvs" class="section level2">
<h2>Creating <code>disk.frame</code> from CSVs</h2>
<p>The function <code>csv_to_disk.frame</code> can convert CSV files to <code>disk.frame</code>. The most basic usage is</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" title="1">some.df =<span class="st"> </span><span class="kw">csv_to_disk.frame</span>(<span class="st">&quot;some/path.csv&quot;</span>, <span class="dt">outdir =</span> <span class="st">&quot;some.df&quot;</span>)</a></code></pre></div>
<p>this will convert the CSV file <code>&quot;some/path.csv&quot;</code> to a <code>disk.frame</code>.</p>
</div>
<div id="multiple-csv-files" class="section level2">
<h2>Multiple CSV files</h2>
<p>However, sometimes we have multiple CSV files that you want to read in and row-bind into one large <code>disk.frame</code>. You can do so by supplying a vector of file paths e.g. from the result of <code>list.files</code></p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" title="1">some.df =<span class="st"> </span><span class="kw">csv_to_disk.frame</span>(<span class="kw">c</span>(<span class="st">&quot;some/path/file1.csv&quot;</span>, <span class="st">&quot;some/path/file2.csv&quot;</span>))</a>
<a class="sourceLine" id="cb6-2" title="2"></a>
<a class="sourceLine" id="cb6-3" title="3"><span class="co"># or</span></a>
<a class="sourceLine" id="cb6-4" title="4">some.df =<span class="st"> </span><span class="kw">csv_to_disk.frame</span>(<span class="kw">list.files</span>(<span class="st">&quot;some/path&quot;</span>))</a></code></pre></div>
</div>
<div id="inputing-csv-files-chunk-wise" class="section level2">
<h2>Inputing CSV files chunk-wise</h2>
<p>The <code>csv_to_disk.frame(path, ...)</code> function reads the file located at <code>path</code> in full into RAM but sometimes the CSV file may be too large to read in one go, as that would require loading the whole file into RAM. In that case, you can read the files chunk-by-chunk by using the <code>in_chunk_size</code> argument which controls how many rows you read in per chunk</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" title="1"><span class="co"># to read in 1 million (=1e6) rows per chunk</span></a>
<a class="sourceLine" id="cb7-2" title="2"><span class="kw">csv_to_disk.frame</span>(path, <span class="dt">in_chunk_size =</span> <span class="fl">1e6</span>)</a></code></pre></div>
</div>
<div id="sharding" class="section level2">
<h2>Sharding</h2>
<p>One of the most important aspects of <code>disk.frame</code> is sharding. One can shard a <code>disk.frame</code> at read time by using the <code>shardby</code></p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" title="1"><span class="kw">csv_to_disk.frame</span>(path, <span class="dt">shardby =</span> <span class="st">&quot;id&quot;</span>)</a></code></pre></div>
<p>In the above case, all rows with the same <code>id</code> values will end up in the same chunk.</p>
</div>
<div id="just-in-time-transformation" class="section level2">
<h2>Just-in-time transformation</h2>
<p>Sometimes, one may wish to perform some transformation on the CSV before writing out to disk. One can use the <code>inmapfn</code> argument to do that. The <code>inmapfn</code> name comes from INput MAPping FuNction. The general usage pattern is as follows:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" title="1"><span class="kw">csv_to_disk.frame</span>(<span class="kw">file.path</span>(<span class="kw">tempdir</span>(), <span class="st">&quot;df.csv&quot;</span>), <span class="dt">inmapfn =</span> <span class="cf">function</span>(chunk) {</a>
<a class="sourceLine" id="cb9-2" title="2">  <span class="kw">some_transformation</span>(chunk)</a>
<a class="sourceLine" id="cb9-3" title="3">})</a></code></pre></div>
<p>As a contrived example, suppose you wish to convert a string into date at read time:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" title="1">df =<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">date_str =</span> <span class="kw">c</span>(<span class="st">&quot;2019-01-02&quot;</span>, <span class="st">&quot;2019-01-02&quot;</span>))</a>
<a class="sourceLine" id="cb10-2" title="2"></a>
<a class="sourceLine" id="cb10-3" title="3"><span class="co"># write the data.frame </span></a>
<a class="sourceLine" id="cb10-4" title="4"><span class="kw">write.csv</span>(df, <span class="kw">file.path</span>(<span class="kw">tempdir</span>(), <span class="st">&quot;df.csv&quot;</span>))</a>
<a class="sourceLine" id="cb10-5" title="5"></a>
<a class="sourceLine" id="cb10-6" title="6"></a>
<a class="sourceLine" id="cb10-7" title="7"><span class="co"># this would show that date_str is a string</span></a>
<a class="sourceLine" id="cb10-8" title="8"><span class="kw">str</span>(<span class="kw">collect</span>(<span class="kw">csv_to_disk.frame</span>(<span class="kw">file.path</span>(<span class="kw">tempdir</span>(), <span class="st">&quot;df.csv&quot;</span>)))<span class="op">$</span>date_str)</a>
<a class="sourceLine" id="cb10-9" title="9"><span class="co">## chr [1:2] &quot;2019-01-02&quot; &quot;2019-01-02&quot;</span></a>
<a class="sourceLine" id="cb10-10" title="10"></a>
<a class="sourceLine" id="cb10-11" title="11"><span class="co"># this would show that date_str is a string</span></a>
<a class="sourceLine" id="cb10-12" title="12">df =<span class="st"> </span><span class="kw">csv_to_disk.frame</span>(<span class="kw">file.path</span>(<span class="kw">tempdir</span>(), <span class="st">&quot;df.csv&quot;</span>), <span class="dt">inmapfn =</span> <span class="cf">function</span>(chunk) {</a>
<a class="sourceLine" id="cb10-13" title="13">  <span class="co"># convert to date_str to date format and store as &quot;date&quot;</span></a>
<a class="sourceLine" id="cb10-14" title="14">  chunk[, date <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">as.Date</span>(date_str, <span class="st">&quot;%Y-%m-%d&quot;</span>)]</a>
<a class="sourceLine" id="cb10-15" title="15">  chunk[, date_str<span class="op">:</span><span class="er">=</span><span class="ot">NULL</span>]</a>
<a class="sourceLine" id="cb10-16" title="16">})</a>
<a class="sourceLine" id="cb10-17" title="17"></a>
<a class="sourceLine" id="cb10-18" title="18"><span class="kw">str</span>(<span class="kw">collect</span>(df)<span class="op">$</span>date)</a>
<a class="sourceLine" id="cb10-19" title="19"><span class="co">## Date[1:2], format: &quot;2019-01-02&quot; &quot;2019-01-02&quot;</span></a></code></pre></div>
</div>
<div id="reading-csvs-from-zip-files" class="section level2">
<h2>Reading CSVs from zip files</h2>
<p>Often, CSV comes zipped in a zip files. You can use the <code>zip_to_disk.frame</code> to convert all CSVs within a zip file</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" title="1"><span class="kw">zip_to_disk.frame</span>(path_to_zip_file)</a></code></pre></div>
<p>The arguments for <code>zip_to_disk.frame</code> are the same as <code>csv_to_disk.frame</code>’s.</p>
</div>
<div id="using-add_chunk" class="section level2">
<h2>Using <code>add_chunk</code></h2>
<p>What if the method of converting to a <code>disk.frame</code> isn’t implemented in <code>disk.frame</code> yet? One can use some lower level constructs provided by <code>disk.frame</code> to create <code>disk.frame</code>s. For example, the <code>add_chunk</code> function can be used to add more chunks to a <code>disk.frame</code>, e.g.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" title="1">a.df =<span class="st"> </span><span class="kw">disk.frame</span>() <span class="co"># create an empty disk.frame</span></a>
<a class="sourceLine" id="cb12-2" title="2"><span class="kw">add_chunk</span>(a.df, cars) <span class="co"># adds cars as chunk 1</span></a>
<a class="sourceLine" id="cb12-3" title="3"><span class="kw">add_chunk</span>(a.df, cars) <span class="co"># adds cars as chunk 2</span></a></code></pre></div>
<p>Another example of using <code>add_chunk</code> is via <code>readr</code>’s chunked read functions to create a delimited file reader</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" title="1">delimited_to_disk.frame &lt;-<span class="st"> </span><span class="cf">function</span>(file, outdir, ...) {</a>
<a class="sourceLine" id="cb13-2" title="2">  res.df =<span class="st"> </span><span class="kw">disk.frame</span>(outdir, ...)</a>
<a class="sourceLine" id="cb13-3" title="3">  readr<span class="op">::</span><span class="kw">read_delim_chunked</span>(file, <span class="dt">callback =</span> <span class="cf">function</span>(chunk) {</a>
<a class="sourceLine" id="cb13-4" title="4">    <span class="kw">add_chunk</span>(res.df, chunk)</a>
<a class="sourceLine" id="cb13-5" title="5">  }, ...)</a>
<a class="sourceLine" id="cb13-6" title="6">  </a>
<a class="sourceLine" id="cb13-7" title="7">  res.df</a>
<a class="sourceLine" id="cb13-8" title="8">}</a>
<a class="sourceLine" id="cb13-9" title="9"></a>
<a class="sourceLine" id="cb13-10" title="10"><span class="kw">delimited_to_disk.frame</span>(path, <span class="dt">outdir =</span> <span class="st">&quot;some.df&quot;</span>)</a></code></pre></div>
<p>The above code uses <code>readr</code>’s <code>read_delim_chunked</code> function to read <code>file</code> and call <code>add_chunk</code>. The problem with this approach is that is it sequential in nature and hence is not able to take advantage of parallelism.</p>
</div>
<div id="exploiting-the-structure-of-a-disk.frame" class="section level2">
<h2>Exploiting the structure of a disk.frame</h2>
<p>Of course, a <code>disk.frame</code> is just a folder with many <code>fst</code> files named as <code>1.fst</code>, <code>2.fst</code> etc. So one can simply create these <code>fst</code> files and ensure they have the same variable names and put them in a folder.</p>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
