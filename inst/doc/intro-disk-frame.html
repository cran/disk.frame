<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1">

<meta name="author" content="ZJ" />


<title>Quick Start: Basic Operations with nycflights13</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
code.sourceCode > span { display: inline-block; line-height: 1.25; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>



<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#header {
text-align: center;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; }  code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Quick Start: Basic Operations with nycflights13</h1>
<h4 class="author">ZJ</h4>



<div id="quick-start---replicating-dplyrs-tutorial-on-nycflight13" class="section level1">
<h1>Quick Start - replicating dplyr’s tutorial on nycflight13</h1>
<p>The <a href="https://github.com/xiaodaigh/disk.frame"><code>disk.frame</code> package</a> aims to be the answer to the question: how do I manipulate structured tabular data that doesn’t fit into Random Access Memory (RAM)?</p>
<p>In a nutshell, <code>disk.frame</code> makes use of two simple ideas</p>
<ol style="list-style-type: decimal">
<li>split up a larger-than-RAM dataset into chunks and store each chunk in a separate file inside a folder and</li>
<li>provide a convenient API to manipulate these chunks</li>
</ol>
<p><code>disk.frame</code> performs a similar role to distributed systems such as Apache Spark, Python’s Dask, and Julia’s JuliaDB.jl for <em>medium data</em> which are datasets that are too large for RAM but not quite large enough to qualify as <em>big data</em>.</p>
<p>In this tutorial, we introduce <code>disk.frame</code>, address some common questions, and replicate the <a href="https://spark.rstudio.com/dplyr/">sparklyr data manipulation tutorial</a> using <code>disk.frame</code> constructs.</p>
<div id="installation" class="section level2">
<h2>Installation</h2>
<p>Simply run</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="kw">install.packages</span>(<span class="st">&quot;disk.frame&quot;</span>) <span class="co"># when CRAN ready</span></span></code></pre></div>
<p>or</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a>devtools<span class="op">::</span><span class="kw">install_github</span>(<span class="st">&quot;xiaodaigh/disk.frame&quot;</span>)</span></code></pre></div>
</div>
<div id="set-up-disk.frame" class="section level2">
<h2>Set-up <code>disk.frame</code></h2>
<p><code>disk.frame</code> works best if it can process multiple data chunks in parallel. The best way to set-up <code>disk.frame</code> so that each CPU core runs a background worker is by using</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a><span class="kw">setup_disk.frame</span>()</span>
<span id="cb3-2"><a href="#cb3-2"></a></span>
<span id="cb3-3"><a href="#cb3-3"></a><span class="co"># this will allow unlimited amount of data to be passed from worker to worker</span></span>
<span id="cb3-4"><a href="#cb3-4"></a><span class="kw">options</span>(<span class="dt">future.globals.maxSize =</span> <span class="ot">Inf</span>)</span></code></pre></div>
<p>The <code>setup_disk.frame()</code> sets up background workers equal to the number of CPU cores; please note that, by default, hyper-threaded cores are counted as one not two.</p>
<p>Alternatively, one may specify the number of workers using <code>setup_disk.frame(workers = n)</code>.</p>
</div>
<div id="basic-data-operations-with-disk.frame" class="section level2">
<h2>Basic Data Operations with <code>disk.frame</code></h2>
<p>The <code>disk.frame</code> package provides convenient functions to convert <code>data.frame</code>s and CSVs to <code>disk.frame</code>s.</p>
<div id="creating-a-disk.frame-from-data.frame" class="section level3">
<h3>Creating a <code>disk.frame</code> from <code>data.frame</code></h3>
<p>We convert a <code>data.frame</code> to <code>disk.frame</code> using the <code>as.data.frame</code> function.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a><span class="kw">library</span>(nycflights13)</span>
<span id="cb4-2"><a href="#cb4-2"></a><span class="kw">library</span>(dplyr)</span>
<span id="cb4-3"><a href="#cb4-3"></a><span class="kw">library</span>(disk.frame)</span>
<span id="cb4-4"><a href="#cb4-4"></a><span class="kw">library</span>(data.table)</span>
<span id="cb4-5"><a href="#cb4-5"></a></span>
<span id="cb4-6"><a href="#cb4-6"></a><span class="co"># convert the flights data to a disk.frame and store the disk.frame in the folder</span></span>
<span id="cb4-7"><a href="#cb4-7"></a><span class="co"># &quot;tmp_flights&quot; and overwrite any content if needed</span></span>
<span id="cb4-8"><a href="#cb4-8"></a>flights.df &lt;-<span class="st"> </span><span class="kw">as.disk.frame</span>(</span>
<span id="cb4-9"><a href="#cb4-9"></a>  flights, </span>
<span id="cb4-10"><a href="#cb4-10"></a>  <span class="dt">outdir =</span> <span class="kw">file.path</span>(<span class="kw">tempdir</span>(), <span class="st">&quot;tmp_flights.df&quot;</span>),</span>
<span id="cb4-11"><a href="#cb4-11"></a>  <span class="dt">overwrite =</span> <span class="ot">TRUE</span>)</span>
<span id="cb4-12"><a href="#cb4-12"></a>flights.df</span>
<span id="cb4-13"><a href="#cb4-13"></a><span class="co">#&gt; path: &quot;C:\Users\RTX2080\AppData\Local\Temp\RtmpaKN4v5/tmp_flights.df&quot;</span></span>
<span id="cb4-14"><a href="#cb4-14"></a><span class="co">#&gt; nchunks: 6</span></span>
<span id="cb4-15"><a href="#cb4-15"></a><span class="co">#&gt; nrow (at source): 336776</span></span>
<span id="cb4-16"><a href="#cb4-16"></a><span class="co">#&gt; ncol (at source): 19</span></span>
<span id="cb4-17"><a href="#cb4-17"></a><span class="co">#&gt; nrow (post operations): ???</span></span>
<span id="cb4-18"><a href="#cb4-18"></a><span class="co">#&gt; ncol (post operations): ???</span></span></code></pre></div>
<p>You should now see a folder called <code>tmp_flights</code> with some files in it, namely <code>1.fst</code>, <code>2.fst</code>…. where each <code>fst</code> files is one chunk of the <code>disk.frame</code>.</p>
</div>
<div id="creating-a-disk.frame-from-csv" class="section level3">
<h3>Creating a <code>disk.frame</code> from CSV</h3>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a><span class="kw">library</span>(nycflights13)</span>
<span id="cb5-2"><a href="#cb5-2"></a><span class="co"># write a csv</span></span>
<span id="cb5-3"><a href="#cb5-3"></a>csv_path =<span class="st"> </span><span class="kw">file.path</span>(<span class="kw">tempdir</span>(), <span class="st">&quot;tmp_flights.csv&quot;</span>)</span>
<span id="cb5-4"><a href="#cb5-4"></a>data.table<span class="op">::</span><span class="kw">fwrite</span>(flights, csv_path)</span>
<span id="cb5-5"><a href="#cb5-5"></a></span>
<span id="cb5-6"><a href="#cb5-6"></a><span class="co"># load the csv into a disk.frame</span></span>
<span id="cb5-7"><a href="#cb5-7"></a>df_path =<span class="st"> </span><span class="kw">file.path</span>(<span class="kw">tempdir</span>(), <span class="st">&quot;tmp_flights.df&quot;</span>)</span>
<span id="cb5-8"><a href="#cb5-8"></a>flights.df &lt;-<span class="st"> </span><span class="kw">csv_to_disk.frame</span>(</span>
<span id="cb5-9"><a href="#cb5-9"></a>  csv_path, </span>
<span id="cb5-10"><a href="#cb5-10"></a>  <span class="dt">outdir =</span> df_path,</span>
<span id="cb5-11"><a href="#cb5-11"></a>  <span class="dt">overwrite =</span> T)</span>
<span id="cb5-12"><a href="#cb5-12"></a>  </span>
<span id="cb5-13"><a href="#cb5-13"></a>flights.df</span>
<span id="cb5-14"><a href="#cb5-14"></a><span class="co">#&gt; path: &quot;C:\Users\RTX2080\AppData\Local\Temp\RtmpaKN4v5/tmp_flights.df&quot;</span></span>
<span id="cb5-15"><a href="#cb5-15"></a><span class="co">#&gt; nchunks: 6</span></span>
<span id="cb5-16"><a href="#cb5-16"></a><span class="co">#&gt; nrow (at source): 336776</span></span>
<span id="cb5-17"><a href="#cb5-17"></a><span class="co">#&gt; ncol (at source): 19</span></span>
<span id="cb5-18"><a href="#cb5-18"></a><span class="co">#&gt; nrow (post operations): ???</span></span>
<span id="cb5-19"><a href="#cb5-19"></a><span class="co">#&gt; ncol (post operations): ???</span></span></code></pre></div>
<p>If the CSV is too large to read in, then we can also use the <code>in_chunk_size</code> option to control how many rows to read in at once. For example to read in the data 100,000 rows at a time.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a><span class="kw">library</span>(nycflights13)</span>
<span id="cb6-2"><a href="#cb6-2"></a><span class="kw">library</span>(disk.frame)</span>
<span id="cb6-3"><a href="#cb6-3"></a></span>
<span id="cb6-4"><a href="#cb6-4"></a><span class="co"># write a csv</span></span>
<span id="cb6-5"><a href="#cb6-5"></a>csv_path =<span class="st"> </span><span class="kw">file.path</span>(<span class="kw">tempdir</span>(), <span class="st">&quot;tmp_flights.csv&quot;</span>)</span>
<span id="cb6-6"><a href="#cb6-6"></a></span>
<span id="cb6-7"><a href="#cb6-7"></a>data.table<span class="op">::</span><span class="kw">fwrite</span>(flights, csv_path)</span>
<span id="cb6-8"><a href="#cb6-8"></a></span>
<span id="cb6-9"><a href="#cb6-9"></a>df_path =<span class="st"> </span><span class="kw">file.path</span>(<span class="kw">tempdir</span>(), <span class="st">&quot;tmp_flights.df&quot;</span>)</span>
<span id="cb6-10"><a href="#cb6-10"></a></span>
<span id="cb6-11"><a href="#cb6-11"></a>flights.df &lt;-<span class="st"> </span><span class="kw">csv_to_disk.frame</span>(</span>
<span id="cb6-12"><a href="#cb6-12"></a>  csv_path, </span>
<span id="cb6-13"><a href="#cb6-13"></a>  <span class="dt">outdir =</span> df_path, </span>
<span id="cb6-14"><a href="#cb6-14"></a>  <span class="dt">in_chunk_size =</span> <span class="dv">100000</span>)</span>
<span id="cb6-15"><a href="#cb6-15"></a><span class="co">#&gt;  -----------------------------------------------------</span></span>
<span id="cb6-16"><a href="#cb6-16"></a><span class="co">#&gt; Stage 1 of 2: splitting the file C:\Users\RTX2080\AppData\Local\Temp\RtmpaKN4v5/tmp_flights.csv into smallers files:</span></span>
<span id="cb6-17"><a href="#cb6-17"></a><span class="co">#&gt; Destination: C:\Users\RTX2080\AppData\Local\Temp\RtmpaKN4v5\file4846eb9862</span></span>
<span id="cb6-18"><a href="#cb6-18"></a><span class="co">#&gt;  -----------------------------------------------------</span></span>
<span id="cb6-19"><a href="#cb6-19"></a><span class="co">#&gt; Stage 1 of 2 took: 0.150s elapsed (0.060s cpu)</span></span>
<span id="cb6-20"><a href="#cb6-20"></a><span class="co">#&gt;  -----------------------------------------------------</span></span>
<span id="cb6-21"><a href="#cb6-21"></a><span class="co">#&gt; Stage 2 of 2: Converting the smaller files into disk.frame</span></span>
<span id="cb6-22"><a href="#cb6-22"></a><span class="co">#&gt;  -----------------------------------------------------</span></span>
<span id="cb6-23"><a href="#cb6-23"></a><span class="co">#&gt; csv_to_disk.frame: you are trying to read multiple files.</span></span>
<span id="cb6-24"><a href="#cb6-24"></a><span class="co">#&gt; Please use colClasses to set column types to minimize the chance of a failed read</span></span>
<span id="cb6-25"><a href="#cb6-25"></a><span class="co">#&gt; -- Converting CSVs to disk.frame --</span></span>
<span id="cb6-26"><a href="#cb6-26"></a><span class="co">#&gt; Converting 4 CSVs to 6 disk.frame each consisting of 6 chunks (Stage 1 of 2):</span></span>
<span id="cb6-27"><a href="#cb6-27"></a><span class="co">#&gt; Stage 1 or 2 took: 2.470s elapsed (0.020s cpu)</span></span>
<span id="cb6-28"><a href="#cb6-28"></a><span class="co">#&gt; </span></span>
<span id="cb6-29"><a href="#cb6-29"></a><span class="co">#&gt; Row-binding the 6 disk.frames together to form one large disk.frame (Stage 2 of 2):</span></span>
<span id="cb6-30"><a href="#cb6-30"></a><span class="co">#&gt; Creating the disk.frame at C:\Users\RTX2080\AppData\Local\Temp\RtmpaKN4v5/tmp_flights.df</span></span>
<span id="cb6-31"><a href="#cb6-31"></a><span class="co">#&gt; Appending disk.frames:</span></span>
<span id="cb6-32"><a href="#cb6-32"></a><span class="co">#&gt; Stage 2 of 2 took: 0.450s elapsed (0.140s cpu)</span></span>
<span id="cb6-33"><a href="#cb6-33"></a><span class="co">#&gt;  -----------------------------------------------------</span></span>
<span id="cb6-34"><a href="#cb6-34"></a><span class="co">#&gt; Stage 1 &amp; 2 in total took: 2.920s elapsed (0.160s cpu)</span></span>
<span id="cb6-35"><a href="#cb6-35"></a><span class="co">#&gt; Stage 2 of 2 took: 2.920s elapsed (0.160s cpu)</span></span>
<span id="cb6-36"><a href="#cb6-36"></a><span class="co">#&gt;  -----------------------------------------------------</span></span>
<span id="cb6-37"><a href="#cb6-37"></a><span class="co">#&gt; Stage 2 &amp; 2 took: 3.070s elapsed (0.220s cpu)</span></span>
<span id="cb6-38"><a href="#cb6-38"></a><span class="co">#&gt;  -----------------------------------------------------</span></span>
<span id="cb6-39"><a href="#cb6-39"></a>  </span>
<span id="cb6-40"><a href="#cb6-40"></a>flights.df</span>
<span id="cb6-41"><a href="#cb6-41"></a><span class="co">#&gt; path: &quot;C:\Users\RTX2080\AppData\Local\Temp\RtmpaKN4v5/tmp_flights.df&quot;</span></span>
<span id="cb6-42"><a href="#cb6-42"></a><span class="co">#&gt; nchunks: 6</span></span>
<span id="cb6-43"><a href="#cb6-43"></a><span class="co">#&gt; nrow (at source): 336776</span></span>
<span id="cb6-44"><a href="#cb6-44"></a><span class="co">#&gt; ncol (at source): 19</span></span>
<span id="cb6-45"><a href="#cb6-45"></a><span class="co">#&gt; nrow (post operations): ???</span></span>
<span id="cb6-46"><a href="#cb6-46"></a><span class="co">#&gt; ncol (post operations): ???</span></span></code></pre></div>
<p><code>disk.frame</code> also has a function <code>zip_to_disk.frame</code> that can convert every CSV in a zip file to <code>disk.frame</code>s.</p>
</div>
<div id="simple-dplyr-verbs-and-lazy-evaluation" class="section level3">
<h3>Simple <code>dplyr</code> verbs and lazy evaluation</h3>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a>flights.df1 &lt;-<span class="st"> </span><span class="kw">select</span>(flights.df, year<span class="op">:</span>day, arr_delay, dep_delay)</span>
<span id="cb7-2"><a href="#cb7-2"></a>flights.df1</span>
<span id="cb7-3"><a href="#cb7-3"></a><span class="co">#&gt; path: &quot;C:\Users\RTX2080\AppData\Local\Temp\RtmpaKN4v5/tmp_flights.df&quot;</span></span>
<span id="cb7-4"><a href="#cb7-4"></a><span class="co">#&gt; nchunks: 6</span></span>
<span id="cb7-5"><a href="#cb7-5"></a><span class="co">#&gt; nrow (at source): 336776</span></span>
<span id="cb7-6"><a href="#cb7-6"></a><span class="co">#&gt; ncol (at source): 19</span></span>
<span id="cb7-7"><a href="#cb7-7"></a><span class="co">#&gt; nrow (post operations): ???</span></span>
<span id="cb7-8"><a href="#cb7-8"></a><span class="co">#&gt; ncol (post operations): ???</span></span></code></pre></div>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1"></a><span class="kw">class</span>(flights.df1)</span>
<span id="cb8-2"><a href="#cb8-2"></a><span class="co">#&gt; [1] &quot;disk.frame&quot;        &quot;disk.frame.folder&quot;</span></span></code></pre></div>
<p>The class of <code>flights.df1</code> is also a <code>disk.frame</code> after the <code>dplyr::select</code> transformation. Also, <code>disk.frame</code> operations are by default (and where possible) <strong>lazy</strong>, meaning it doesn’t perform the operations right away. Instead, it waits until you call <code>collect</code>. Exceptions to this rule are the <code>*_join</code> operations which evaluated <em>eagerly</em> under certain conditions see <strong>Joins for disk.frame in-depth</strong> for details.</p>
<p>For lazily constructed <code>disk.frame</code>s (e.g. <code>flights.df1</code>). The function <code>collect</code> can be used to bring the results from disk into R, e.g.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1"></a><span class="kw">collect</span>(flights.df1) <span class="op">%&gt;%</span><span class="st"> </span>head</span>
<span id="cb9-2"><a href="#cb9-2"></a><span class="co">#&gt;    year month day arr_delay dep_delay</span></span>
<span id="cb9-3"><a href="#cb9-3"></a><span class="co">#&gt; 1: 2013     1   1        11         2</span></span>
<span id="cb9-4"><a href="#cb9-4"></a><span class="co">#&gt; 2: 2013     1   1        20         4</span></span>
<span id="cb9-5"><a href="#cb9-5"></a><span class="co">#&gt; 3: 2013     1   1        33         2</span></span>
<span id="cb9-6"><a href="#cb9-6"></a><span class="co">#&gt; 4: 2013     1   1       -18        -1</span></span>
<span id="cb9-7"><a href="#cb9-7"></a><span class="co">#&gt; 5: 2013     1   1       -25        -6</span></span>
<span id="cb9-8"><a href="#cb9-8"></a><span class="co">#&gt; 6: 2013     1   1        12        -4</span></span></code></pre></div>
<p>Of course, for larger-than-RAM datasets, one wouldn’t call <code>collect</code> on the whole <code>disk.frame</code> (because why would you need <code>disk.frame</code> otherwise). More likely, one would call <code>collect</code> on a <code>filter</code>ed dataset or one summarized with <code>group_by</code>.</p>
<p>Some examples of other dplyr verbs applied:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1"></a><span class="kw">filter</span>(flights.df, dep_delay <span class="op">&gt;</span><span class="st"> </span><span class="dv">1000</span>) <span class="op">%&gt;%</span><span class="st"> </span>collect <span class="op">%&gt;%</span><span class="st"> </span>head</span>
<span id="cb10-2"><a href="#cb10-2"></a><span class="co">#&gt;   year month day dep_time sched_dep_time dep_delay arr_time sched_arr_time</span></span>
<span id="cb10-3"><a href="#cb10-3"></a><span class="co">#&gt; 1 2013     1   9      641            900      1301     1242           1530</span></span>
<span id="cb10-4"><a href="#cb10-4"></a><span class="co">#&gt; 2 2013     1  10     1121           1635      1126     1239           1810</span></span>
<span id="cb10-5"><a href="#cb10-5"></a><span class="co">#&gt; 3 2013     6  15     1432           1935      1137     1607           2120</span></span>
<span id="cb10-6"><a href="#cb10-6"></a><span class="co">#&gt; 4 2013     7  22      845           1600      1005     1044           1815</span></span>
<span id="cb10-7"><a href="#cb10-7"></a><span class="co">#&gt; 5 2013     9  20     1139           1845      1014     1457           2210</span></span>
<span id="cb10-8"><a href="#cb10-8"></a><span class="co">#&gt;   arr_delay carrier flight tailnum origin dest air_time distance hour</span></span>
<span id="cb10-9"><a href="#cb10-9"></a><span class="co">#&gt; 1      1272      HA     51  N384HA    JFK  HNL      640     4983    9</span></span>
<span id="cb10-10"><a href="#cb10-10"></a><span class="co">#&gt; 2      1109      MQ   3695  N517MQ    EWR  ORD      111      719   16</span></span>
<span id="cb10-11"><a href="#cb10-11"></a><span class="co">#&gt; 3      1127      MQ   3535  N504MQ    JFK  CMH       74      483   19</span></span>
<span id="cb10-12"><a href="#cb10-12"></a><span class="co">#&gt; 4       989      MQ   3075  N665MQ    JFK  CVG       96      589   16</span></span>
<span id="cb10-13"><a href="#cb10-13"></a><span class="co">#&gt; 5      1007      AA    177  N338AA    JFK  SFO      354     2586   18</span></span>
<span id="cb10-14"><a href="#cb10-14"></a><span class="co">#&gt;   minute            time_hour</span></span>
<span id="cb10-15"><a href="#cb10-15"></a><span class="co">#&gt; 1      0 2013-01-09T14:00:00Z</span></span>
<span id="cb10-16"><a href="#cb10-16"></a><span class="co">#&gt; 2     35 2013-01-10T21:00:00Z</span></span>
<span id="cb10-17"><a href="#cb10-17"></a><span class="co">#&gt; 3     35 2013-06-15T23:00:00Z</span></span>
<span id="cb10-18"><a href="#cb10-18"></a><span class="co">#&gt; 4      0 2013-07-22T20:00:00Z</span></span>
<span id="cb10-19"><a href="#cb10-19"></a><span class="co">#&gt; 5     45 2013-09-20T22:00:00Z</span></span></code></pre></div>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1"></a><span class="kw">mutate</span>(flights.df, <span class="dt">speed =</span> distance <span class="op">/</span><span class="st"> </span>air_time <span class="op">*</span><span class="st"> </span><span class="dv">60</span>) <span class="op">%&gt;%</span><span class="st"> </span>collect <span class="op">%&gt;%</span><span class="st"> </span>head</span>
<span id="cb11-2"><a href="#cb11-2"></a><span class="co">#&gt;   year month day dep_time sched_dep_time dep_delay arr_time sched_arr_time</span></span>
<span id="cb11-3"><a href="#cb11-3"></a><span class="co">#&gt; 1 2013     1   1      517            515         2      830            819</span></span>
<span id="cb11-4"><a href="#cb11-4"></a><span class="co">#&gt; 2 2013     1   1      533            529         4      850            830</span></span>
<span id="cb11-5"><a href="#cb11-5"></a><span class="co">#&gt; 3 2013     1   1      542            540         2      923            850</span></span>
<span id="cb11-6"><a href="#cb11-6"></a><span class="co">#&gt; 4 2013     1   1      544            545        -1     1004           1022</span></span>
<span id="cb11-7"><a href="#cb11-7"></a><span class="co">#&gt; 5 2013     1   1      554            600        -6      812            837</span></span>
<span id="cb11-8"><a href="#cb11-8"></a><span class="co">#&gt; 6 2013     1   1      554            558        -4      740            728</span></span>
<span id="cb11-9"><a href="#cb11-9"></a><span class="co">#&gt;   arr_delay carrier flight tailnum origin dest air_time distance hour</span></span>
<span id="cb11-10"><a href="#cb11-10"></a><span class="co">#&gt; 1        11      UA   1545  N14228    EWR  IAH      227     1400    5</span></span>
<span id="cb11-11"><a href="#cb11-11"></a><span class="co">#&gt; 2        20      UA   1714  N24211    LGA  IAH      227     1416    5</span></span>
<span id="cb11-12"><a href="#cb11-12"></a><span class="co">#&gt; 3        33      AA   1141  N619AA    JFK  MIA      160     1089    5</span></span>
<span id="cb11-13"><a href="#cb11-13"></a><span class="co">#&gt; 4       -18      B6    725  N804JB    JFK  BQN      183     1576    5</span></span>
<span id="cb11-14"><a href="#cb11-14"></a><span class="co">#&gt; 5       -25      DL    461  N668DN    LGA  ATL      116      762    6</span></span>
<span id="cb11-15"><a href="#cb11-15"></a><span class="co">#&gt; 6        12      UA   1696  N39463    EWR  ORD      150      719    5</span></span>
<span id="cb11-16"><a href="#cb11-16"></a><span class="co">#&gt;   minute            time_hour    speed</span></span>
<span id="cb11-17"><a href="#cb11-17"></a><span class="co">#&gt; 1     15 2013-01-01T10:00:00Z 370.0441</span></span>
<span id="cb11-18"><a href="#cb11-18"></a><span class="co">#&gt; 2     29 2013-01-01T10:00:00Z 374.2731</span></span>
<span id="cb11-19"><a href="#cb11-19"></a><span class="co">#&gt; 3     40 2013-01-01T10:00:00Z 408.3750</span></span>
<span id="cb11-20"><a href="#cb11-20"></a><span class="co">#&gt; 4     45 2013-01-01T10:00:00Z 516.7213</span></span>
<span id="cb11-21"><a href="#cb11-21"></a><span class="co">#&gt; 5      0 2013-01-01T11:00:00Z 394.1379</span></span>
<span id="cb11-22"><a href="#cb11-22"></a><span class="co">#&gt; 6     58 2013-01-01T10:00:00Z 287.6000</span></span></code></pre></div>
</div>
<div id="examples-of-not-fully-supported-dplyr-verbs" class="section level3">
<h3>Examples of NOT fully supported <code>dplyr</code> verbs</h3>
<p>The <code>chunk_arrange</code> function arranges (sorts) each chunk but not the whole dataset. So use with caution. Similarly <code>chunk_summarise</code> creates summary variables within each chunk and hence also needs to be used with caution. In the Group By section, we demonstrate how to use <code>summarise</code> in the <code>disk.frame</code> context correctly with <code>hard_group_by</code>s.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1"></a><span class="co"># this only sorts within each chunk</span></span>
<span id="cb12-2"><a href="#cb12-2"></a><span class="kw">chunk_arrange</span>(flights.df, dplyr<span class="op">::</span><span class="kw">desc</span>(dep_delay)) <span class="op">%&gt;%</span><span class="st"> </span>collect <span class="op">%&gt;%</span><span class="st"> </span>head</span>
<span id="cb12-3"><a href="#cb12-3"></a><span class="co">#&gt;   year month day dep_time sched_dep_time dep_delay arr_time sched_arr_time</span></span>
<span id="cb12-4"><a href="#cb12-4"></a><span class="co">#&gt; 1 2013     1   9      641            900      1301     1242           1530</span></span>
<span id="cb12-5"><a href="#cb12-5"></a><span class="co">#&gt; 2 2013     1  10     1121           1635      1126     1239           1810</span></span>
<span id="cb12-6"><a href="#cb12-6"></a><span class="co">#&gt; 3 2013     1   1      848           1835       853     1001           1950</span></span>
<span id="cb12-7"><a href="#cb12-7"></a><span class="co">#&gt; 4 2013     5  19      713           1700       853     1007           1955</span></span>
<span id="cb12-8"><a href="#cb12-8"></a><span class="co">#&gt; 5 2013     1  13     1809            810       599     2054           1042</span></span>
<span id="cb12-9"><a href="#cb12-9"></a><span class="co">#&gt; 6 2013     5  16     2233           1340       533       59           1640</span></span>
<span id="cb12-10"><a href="#cb12-10"></a><span class="co">#&gt;   arr_delay carrier flight tailnum origin dest air_time distance hour</span></span>
<span id="cb12-11"><a href="#cb12-11"></a><span class="co">#&gt; 1      1272      HA     51  N384HA    JFK  HNL      640     4983    9</span></span>
<span id="cb12-12"><a href="#cb12-12"></a><span class="co">#&gt; 2      1109      MQ   3695  N517MQ    EWR  ORD      111      719   16</span></span>
<span id="cb12-13"><a href="#cb12-13"></a><span class="co">#&gt; 3       851      MQ   3944  N942MQ    JFK  BWI       41      184   18</span></span>
<span id="cb12-14"><a href="#cb12-14"></a><span class="co">#&gt; 4       852      AA    257  N3HEAA    JFK  LAS      323     2248   17</span></span>
<span id="cb12-15"><a href="#cb12-15"></a><span class="co">#&gt; 5       612      DL    269  N322NB    JFK  ATL      116      760    8</span></span>
<span id="cb12-16"><a href="#cb12-16"></a><span class="co">#&gt; 6       499      AA    753  N3ERAA    LGA  DFW      184     1389   13</span></span>
<span id="cb12-17"><a href="#cb12-17"></a><span class="co">#&gt;   minute            time_hour</span></span>
<span id="cb12-18"><a href="#cb12-18"></a><span class="co">#&gt; 1      0 2013-01-09T14:00:00Z</span></span>
<span id="cb12-19"><a href="#cb12-19"></a><span class="co">#&gt; 2     35 2013-01-10T21:00:00Z</span></span>
<span id="cb12-20"><a href="#cb12-20"></a><span class="co">#&gt; 3     35 2013-01-01T23:00:00Z</span></span>
<span id="cb12-21"><a href="#cb12-21"></a><span class="co">#&gt; 4      0 2013-05-19T21:00:00Z</span></span>
<span id="cb12-22"><a href="#cb12-22"></a><span class="co">#&gt; 5     10 2013-01-13T13:00:00Z</span></span>
<span id="cb12-23"><a href="#cb12-23"></a><span class="co">#&gt; 6     40 2013-05-16T17:00:00Z</span></span></code></pre></div>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1"></a><span class="kw">chunk_summarize</span>(flights.df, <span class="dt">mean_dep_delay =</span> <span class="kw">mean</span>(dep_delay, <span class="dt">na.rm =</span>T)) <span class="op">%&gt;%</span><span class="st"> </span>collect</span>
<span id="cb13-2"><a href="#cb13-2"></a><span class="co">#&gt;   mean_dep_delay</span></span>
<span id="cb13-3"><a href="#cb13-3"></a><span class="co">#&gt; 1       12.32700</span></span>
<span id="cb13-4"><a href="#cb13-4"></a><span class="co">#&gt; 2       12.01291</span></span>
<span id="cb13-5"><a href="#cb13-5"></a><span class="co">#&gt; 3       13.81315</span></span>
<span id="cb13-6"><a href="#cb13-6"></a><span class="co">#&gt; 4       12.94445</span></span>
<span id="cb13-7"><a href="#cb13-7"></a><span class="co">#&gt; 5       12.67813</span></span>
<span id="cb13-8"><a href="#cb13-8"></a><span class="co">#&gt; 6       12.05854</span></span></code></pre></div>
</div>
<div id="piping" class="section level3">
<h3>Piping</h3>
<p>One can chain <code>dplyr</code> verbs together like with a <code>data.frame</code></p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1"></a>c4 &lt;-<span class="st"> </span>flights <span class="op">%&gt;%</span></span>
<span id="cb14-2"><a href="#cb14-2"></a><span class="st">  </span><span class="kw">filter</span>(month <span class="op">==</span><span class="st"> </span><span class="dv">5</span>, day <span class="op">==</span><span class="st"> </span><span class="dv">17</span>, carrier <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&#39;UA&#39;</span>, <span class="st">&#39;WN&#39;</span>, <span class="st">&#39;AA&#39;</span>, <span class="st">&#39;DL&#39;</span>)) <span class="op">%&gt;%</span></span>
<span id="cb14-3"><a href="#cb14-3"></a><span class="st">  </span><span class="kw">select</span>(carrier, dep_delay, air_time, distance) <span class="op">%&gt;%</span></span>
<span id="cb14-4"><a href="#cb14-4"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">air_time_hours =</span> air_time <span class="op">/</span><span class="st"> </span><span class="dv">60</span>) <span class="op">%&gt;%</span></span>
<span id="cb14-5"><a href="#cb14-5"></a><span class="st">  </span>collect <span class="op">%&gt;%</span></span>
<span id="cb14-6"><a href="#cb14-6"></a><span class="st">  </span><span class="kw">arrange</span>(carrier)<span class="co"># arrange should occur after `collect`</span></span>
<span id="cb14-7"><a href="#cb14-7"></a></span>
<span id="cb14-8"><a href="#cb14-8"></a>c4  <span class="op">%&gt;%</span><span class="st"> </span>head</span>
<span id="cb14-9"><a href="#cb14-9"></a><span class="co">#&gt;   carrier dep_delay air_time distance air_time_hours</span></span>
<span id="cb14-10"><a href="#cb14-10"></a><span class="co">#&gt; 1      AA        -7      142     1089       2.366667</span></span>
<span id="cb14-11"><a href="#cb14-11"></a><span class="co">#&gt; 2      AA        -9      186     1389       3.100000</span></span>
<span id="cb14-12"><a href="#cb14-12"></a><span class="co">#&gt; 3      AA        -6      143     1096       2.383333</span></span>
<span id="cb14-13"><a href="#cb14-13"></a><span class="co">#&gt; 4      AA        -4      114      733       1.900000</span></span>
<span id="cb14-14"><a href="#cb14-14"></a><span class="co">#&gt; 5      AA        -2      146     1085       2.433333</span></span>
<span id="cb14-15"><a href="#cb14-15"></a><span class="co">#&gt; 6      AA        -7      119      733       1.983333</span></span></code></pre></div>
</div>
<div id="list-of-supported-dplyr-verbs" class="section level3">
<h3>List of supported <code>dplyr</code> verbs</h3>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1"></a>select</span>
<span id="cb15-2"><a href="#cb15-2"></a>rename</span>
<span id="cb15-3"><a href="#cb15-3"></a>filter</span>
<span id="cb15-4"><a href="#cb15-4"></a>chunk_arrange <span class="co"># within each chunk</span></span>
<span id="cb15-5"><a href="#cb15-5"></a>chunk_group_by <span class="co"># within each chunk</span></span>
<span id="cb15-6"><a href="#cb15-6"></a>chunk_summarise<span class="op">/</span>chunk_summarize <span class="co"># within each chunk</span></span>
<span id="cb15-7"><a href="#cb15-7"></a>mutate</span>
<span id="cb15-8"><a href="#cb15-8"></a>transmute</span>
<span id="cb15-9"><a href="#cb15-9"></a>left_join</span>
<span id="cb15-10"><a href="#cb15-10"></a>inner_join</span>
<span id="cb15-11"><a href="#cb15-11"></a>full_join <span class="co"># careful. Performance!</span></span>
<span id="cb15-12"><a href="#cb15-12"></a>semi_join</span>
<span id="cb15-13"><a href="#cb15-13"></a>anit_join</span></code></pre></div>
</div>
</div>
<div id="sharding-and-distribution-of-chunks" class="section level2">
<h2>Sharding and distribution of chunks</h2>
<p>Like other distributed data manipulation frameworks <code>disk.frame</code> utilizes the <em>sharding</em> concept to distribute the data into chunks. For example “to shard by <code>cust_id</code>” means that all rows with the same <code>cust_id</code> will be stored in the same chunk. This enables <code>chunk_group_by</code> by <code>cust_id</code> to produce the same results as non-chunked data.</p>
<p>The <code>by</code> variables that were used to shard the dataset are called the <code>shardkey</code>s. The <em>sharding</em> is performed by computing a deterministic hash on the shard keys (the <code>by</code> variables) for each row. The hash function produces an integer between <code>1</code> and <code>n</code>, where <code>n</code> is the number of chunks.</p>
</div>
<div id="grouping" class="section level2">
<h2>Grouping</h2>
<p>The <code>disk.frame</code> implements the <code>chunk_group_by</code> operation with a significant caveat. In the <code>disk.frame</code> framework, group-by happens WITHIN each chunk and not ACROSS chunks. To achieve group by across chunk we need to put <strong>all rows with the same group keys into the same file chunk</strong>; this can be achieved with <code>hard_group_by</code>. However, the <code>hard_group_by</code> operation can be <strong>VERY TIME CONSUMING</strong> computationally and should be <strong>avoided</strong> if possible.</p>
<p>The <code>hard_group_by</code> operation is best illustrated with an example, suppose a <code>disk.frame</code> has three chunks</p>
<pre><code># chunk1 = 1.fst
#  id n
#1  a 1
#2  a 2
#3  b 3
#4  d 4

# chunk2 = 2.fst
#  id n
#1  a 4
#2  a 5
#3  b 6
#4  d 7

# chunk3 = 3.fst
#  id n
#1  a 4
#2  b 5
#3  c 6</code></pre>
<p>and notice that the <code>id</code> column contains 3 distinct values <code>&quot;a&quot;</code>,<code>&quot;b&quot;</code>, and <code>&quot;c&quot;</code>. To perform <code>hard_group_by(df, by = id)</code> MAY give you the following <code>disk.frame</code> where all the <code>id</code>s with the same values end up in the same chunks.</p>
<pre><code># chunk1 = 1.fst
#  id n
#1  b 3
#2  b 6

# chunk2 = 2.fst
#  id n
#1  c 6
#2  d 4
#3  d 7

# chunk3 = 3.fst
#  id n
#1  a 1
#2  a 2
#3  a 4
#4  a 5
#5  a 4</code></pre>
<p>Also, notice that there is no guaranteed order for the distribution of the <code>id</code>s to the chunks. The order is random, but each chunk is likely to have a similar number of rows, provided that <code>id</code> does not follow a skewed distribution i.e. where a few distinct values make up the majority of the rows.</p>
<p>Typically, <code>chunk_group_by</code> is performed WITHIN each chunk. This is not an issue if the chunks have already been sharded on the <code>by</code> variables beforehand; however, if this is not the case then one may need a second stage aggregation to obtain the correct result, see <em>Two-stage group by</em>.</p>
<p>By forcing the user to choose <code>chunk_group_by</code> (within each chunk) and <code>hard_group_by</code> (across all chunks), this ensures that the user is conscious of the choice they are making. In <code>sparklyr</code> the equivalent of a <code>hard_group_by</code> is performed, which we should avoid, where possible, as it is time-consuming and expensive. Hence, <code>disk.frame</code> has chosen to explain the theory and allow the user to make a conscious choice when performing <code>group_by</code>.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1"></a>flights.df <span class="op">%&gt;%</span></span>
<span id="cb18-2"><a href="#cb18-2"></a><span class="st">  </span><span class="kw">hard_group_by</span>(carrier) <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># notice that hard_group_by needs to be set</span></span>
<span id="cb18-3"><a href="#cb18-3"></a><span class="st">  </span><span class="kw">chunk_summarize</span>(<span class="dt">count =</span> <span class="kw">n</span>(), <span class="dt">mean_dep_delay =</span> <span class="kw">mean</span>(dep_delay, <span class="dt">na.rm=</span>T)) <span class="op">%&gt;%</span><span class="st">  </span><span class="co"># mean follows normal R rules</span></span>
<span id="cb18-4"><a href="#cb18-4"></a><span class="st">  </span>collect <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb18-5"><a href="#cb18-5"></a><span class="st">  </span><span class="kw">arrange</span>(carrier)</span>
<span id="cb18-6"><a href="#cb18-6"></a><span class="co">#&gt; Appending disk.frames:</span></span>
<span id="cb18-7"><a href="#cb18-7"></a><span class="co">#&gt; # A tibble: 16 x 3</span></span>
<span id="cb18-8"><a href="#cb18-8"></a><span class="co">#&gt;    carrier count mean_dep_delay</span></span>
<span id="cb18-9"><a href="#cb18-9"></a><span class="co">#&gt;    &lt;chr&gt;   &lt;int&gt;          &lt;dbl&gt;</span></span>
<span id="cb18-10"><a href="#cb18-10"></a><span class="co">#&gt;  1 9E      18460          16.7 </span></span>
<span id="cb18-11"><a href="#cb18-11"></a><span class="co">#&gt;  2 AA      32729           8.59</span></span>
<span id="cb18-12"><a href="#cb18-12"></a><span class="co">#&gt;  3 AS        714           5.80</span></span>
<span id="cb18-13"><a href="#cb18-13"></a><span class="co">#&gt;  4 B6      54635          13.0 </span></span>
<span id="cb18-14"><a href="#cb18-14"></a><span class="co">#&gt;  5 DL      48110           9.26</span></span>
<span id="cb18-15"><a href="#cb18-15"></a><span class="co">#&gt;  6 EV      54173          20.0 </span></span>
<span id="cb18-16"><a href="#cb18-16"></a><span class="co">#&gt;  7 F9        685          20.2 </span></span>
<span id="cb18-17"><a href="#cb18-17"></a><span class="co">#&gt;  8 FL       3260          18.7 </span></span>
<span id="cb18-18"><a href="#cb18-18"></a><span class="co">#&gt;  9 HA        342           4.90</span></span>
<span id="cb18-19"><a href="#cb18-19"></a><span class="co">#&gt; 10 MQ      26397          10.6 </span></span>
<span id="cb18-20"><a href="#cb18-20"></a><span class="co">#&gt; 11 OO         32          12.6 </span></span>
<span id="cb18-21"><a href="#cb18-21"></a><span class="co">#&gt; 12 UA      58665          12.1 </span></span>
<span id="cb18-22"><a href="#cb18-22"></a><span class="co">#&gt; 13 US      20536           3.78</span></span>
<span id="cb18-23"><a href="#cb18-23"></a><span class="co">#&gt; 14 VX       5162          12.9 </span></span>
<span id="cb18-24"><a href="#cb18-24"></a><span class="co">#&gt; 15 WN      12275          17.7 </span></span>
<span id="cb18-25"><a href="#cb18-25"></a><span class="co">#&gt; 16 YV        601          19.0</span></span></code></pre></div>
<div id="two-stage-group-by" class="section level3">
<h3>Two-stage group by</h3>
<p>For most group-by tasks, the user can achieve the desired result WITHOUT using <code>hard = TRUE</code> by performing the group by in two stages. For example, suppose you aim to count the number of rows group by <code>carrier</code>, you can set <code>hard = F</code> to find the count within each chunk and then use a second group-by to summaries each chunk’s results into the desired result. For example,</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1"></a>flights.df <span class="op">%&gt;%</span></span>
<span id="cb19-2"><a href="#cb19-2"></a><span class="st">  </span><span class="kw">chunk_group_by</span>(carrier) <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># `chunk_group_by` aggregates within each chunk</span></span>
<span id="cb19-3"><a href="#cb19-3"></a><span class="st">  </span><span class="kw">chunk_summarize</span>(<span class="dt">count =</span> <span class="kw">n</span>()) <span class="op">%&gt;%</span><span class="st">  </span><span class="co"># mean follows normal R rules</span></span>
<span id="cb19-4"><a href="#cb19-4"></a><span class="st">  </span>collect <span class="op">%&gt;%</span><span class="st">  </span><span class="co"># collect each individul chunks results and row-bind into a data.table</span></span>
<span id="cb19-5"><a href="#cb19-5"></a><span class="st">  </span><span class="kw">group_by</span>(carrier) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb19-6"><a href="#cb19-6"></a><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">count =</span> <span class="kw">sum</span>(count)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb19-7"><a href="#cb19-7"></a><span class="st">  </span><span class="kw">arrange</span>(carrier)</span>
<span id="cb19-8"><a href="#cb19-8"></a><span class="co">#&gt; # A tibble: 16 x 2</span></span>
<span id="cb19-9"><a href="#cb19-9"></a><span class="co">#&gt;    carrier count</span></span>
<span id="cb19-10"><a href="#cb19-10"></a><span class="co">#&gt;    &lt;chr&gt;   &lt;int&gt;</span></span>
<span id="cb19-11"><a href="#cb19-11"></a><span class="co">#&gt;  1 9E      18460</span></span>
<span id="cb19-12"><a href="#cb19-12"></a><span class="co">#&gt;  2 AA      32729</span></span>
<span id="cb19-13"><a href="#cb19-13"></a><span class="co">#&gt;  3 AS        714</span></span>
<span id="cb19-14"><a href="#cb19-14"></a><span class="co">#&gt;  4 B6      54635</span></span>
<span id="cb19-15"><a href="#cb19-15"></a><span class="co">#&gt;  5 DL      48110</span></span>
<span id="cb19-16"><a href="#cb19-16"></a><span class="co">#&gt;  6 EV      54173</span></span>
<span id="cb19-17"><a href="#cb19-17"></a><span class="co">#&gt;  7 F9        685</span></span>
<span id="cb19-18"><a href="#cb19-18"></a><span class="co">#&gt;  8 FL       3260</span></span>
<span id="cb19-19"><a href="#cb19-19"></a><span class="co">#&gt;  9 HA        342</span></span>
<span id="cb19-20"><a href="#cb19-20"></a><span class="co">#&gt; 10 MQ      26397</span></span>
<span id="cb19-21"><a href="#cb19-21"></a><span class="co">#&gt; 11 OO         32</span></span>
<span id="cb19-22"><a href="#cb19-22"></a><span class="co">#&gt; 12 UA      58665</span></span>
<span id="cb19-23"><a href="#cb19-23"></a><span class="co">#&gt; 13 US      20536</span></span>
<span id="cb19-24"><a href="#cb19-24"></a><span class="co">#&gt; 14 VX       5162</span></span>
<span id="cb19-25"><a href="#cb19-25"></a><span class="co">#&gt; 15 WN      12275</span></span>
<span id="cb19-26"><a href="#cb19-26"></a><span class="co">#&gt; 16 YV        601</span></span></code></pre></div>
<p>Because this two-stage approach avoids the expensive <code>hard group_by</code> operation, it is often significantly faster. However, it can be tedious to write; and this is a con of the <code>disk.frame</code> chunking mechanism.</p>
<p><em>Note</em>: this two-stage approach is similar to a map-reduce operation.</p>
</div>
</div>
<div id="restrict-input-columns-for-faster-processing" class="section level2">
<h2>Restrict input columns for faster processing</h2>
<p>One can restrict which input columns to load into memory for each chunk; this can significantly increase the speed of data processing. To restrict the input columns, use the <code>srckeep</code> function which only accepts column names as a string vector.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1"></a>flights.df <span class="op">%&gt;%</span></span>
<span id="cb20-2"><a href="#cb20-2"></a><span class="st">  </span><span class="kw">srckeep</span>(<span class="kw">c</span>(<span class="st">&quot;carrier&quot;</span>,<span class="st">&quot;dep_delay&quot;</span>)) <span class="op">%&gt;%</span></span>
<span id="cb20-3"><a href="#cb20-3"></a><span class="st">  </span><span class="kw">hard_group_by</span>(carrier) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb20-4"><a href="#cb20-4"></a><span class="st">  </span><span class="kw">chunk_summarize</span>(<span class="dt">count =</span> <span class="kw">n</span>(), <span class="dt">mean_dep_delay =</span> <span class="kw">mean</span>(dep_delay, <span class="dt">na.rm=</span>T)) <span class="op">%&gt;%</span><span class="st">  </span><span class="co"># mean follows normal R rules</span></span>
<span id="cb20-5"><a href="#cb20-5"></a><span class="st">  </span>collect</span>
<span id="cb20-6"><a href="#cb20-6"></a><span class="co">#&gt; Appending disk.frames:</span></span>
<span id="cb20-7"><a href="#cb20-7"></a><span class="co">#&gt; # A tibble: 16 x 3</span></span>
<span id="cb20-8"><a href="#cb20-8"></a><span class="co">#&gt;    carrier count mean_dep_delay</span></span>
<span id="cb20-9"><a href="#cb20-9"></a><span class="co">#&gt;    &lt;chr&gt;   &lt;int&gt;          &lt;dbl&gt;</span></span>
<span id="cb20-10"><a href="#cb20-10"></a><span class="co">#&gt;  1 B6      54635          13.0 </span></span>
<span id="cb20-11"><a href="#cb20-11"></a><span class="co">#&gt;  2 FL       3260          18.7 </span></span>
<span id="cb20-12"><a href="#cb20-12"></a><span class="co">#&gt;  3 MQ      26397          10.6 </span></span>
<span id="cb20-13"><a href="#cb20-13"></a><span class="co">#&gt;  4 US      20536           3.78</span></span>
<span id="cb20-14"><a href="#cb20-14"></a><span class="co">#&gt;  5 HA        342           4.90</span></span>
<span id="cb20-15"><a href="#cb20-15"></a><span class="co">#&gt;  6 9E      18460          16.7 </span></span>
<span id="cb20-16"><a href="#cb20-16"></a><span class="co">#&gt;  7 UA      58665          12.1 </span></span>
<span id="cb20-17"><a href="#cb20-17"></a><span class="co">#&gt;  8 AA      32729           8.59</span></span>
<span id="cb20-18"><a href="#cb20-18"></a><span class="co">#&gt;  9 DL      48110           9.26</span></span>
<span id="cb20-19"><a href="#cb20-19"></a><span class="co">#&gt; 10 EV      54173          20.0 </span></span>
<span id="cb20-20"><a href="#cb20-20"></a><span class="co">#&gt; 11 VX       5162          12.9 </span></span>
<span id="cb20-21"><a href="#cb20-21"></a><span class="co">#&gt; 12 WN      12275          17.7 </span></span>
<span id="cb20-22"><a href="#cb20-22"></a><span class="co">#&gt; 13 YV        601          19.0 </span></span>
<span id="cb20-23"><a href="#cb20-23"></a><span class="co">#&gt; 14 OO         32          12.6 </span></span>
<span id="cb20-24"><a href="#cb20-24"></a><span class="co">#&gt; 15 AS        714           5.80</span></span>
<span id="cb20-25"><a href="#cb20-25"></a><span class="co">#&gt; 16 F9        685          20.2</span></span></code></pre></div>
<p>Input column restriction is one of the most critical efficiencies provided by <code>disk.frame</code>. Because the underlying format allows random access to columns (i.e. retrieve only the columns used for processing), hence one can drastically reduce the amount of data loaded into RAM for processing by keeping only those columns that are directly used to produce the results.</p>
</div>
<div id="joins" class="section level2">
<h2>Joins</h2>
<p><code>disk.frame</code> supports many dplyr joins including:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1"></a>left_join</span>
<span id="cb21-2"><a href="#cb21-2"></a>inner_join</span>
<span id="cb21-3"><a href="#cb21-3"></a>semi_join</span>
<span id="cb21-4"><a href="#cb21-4"></a>inner_join</span>
<span id="cb21-5"><a href="#cb21-5"></a>full_join <span class="co"># requires hard_group_by on both left and right</span></span></code></pre></div>
<p>In all cases, the left dataset (<code>x</code>) must be a <code>disk.frame</code>, and the right dataset (<code>y</code>) can be either a <code>disk.frame</code> or a <code>data.frame</code>. If the right dataset is a <code>disk.frame</code> and the <code>shardkey</code>s are different between the two <code>disk.frame</code>s then two expensive <code>hard</code> <code>group_by</code> operations are performed <em>eagerly</em>, one on the left <code>disk.frame</code> and one on the right <code>disk.frame</code> to perform the joins correctly.</p>
<p>However, if the right dataset is a <code>data.frame</code> then <code>hard_group_by</code>s are only performed in the case of <code>full_join</code>.</p>
<p>Note <code>disk.frame</code> does not support <code>right_join</code> the user should use <code>left_join</code> instead.</p>
<p>The below joins are performed <em>lazily</em> because <code>airlines.dt</code> is a <code>data.table</code> not a <code>disk.frame</code>:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1"></a><span class="co"># make airlines a data.table</span></span>
<span id="cb22-2"><a href="#cb22-2"></a>airlines.dt &lt;-<span class="st"> </span><span class="kw">data.table</span>(airlines)</span>
<span id="cb22-3"><a href="#cb22-3"></a><span class="co"># flights %&gt;% left_join(airlines, by = &quot;carrier&quot;) #</span></span>
<span id="cb22-4"><a href="#cb22-4"></a>flights.df <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb22-5"><a href="#cb22-5"></a><span class="st">  </span><span class="kw">left_join</span>(airlines.dt, <span class="dt">by =</span><span class="st">&quot;carrier&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb22-6"><a href="#cb22-6"></a><span class="st">  </span>collect <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb22-7"><a href="#cb22-7"></a><span class="st">  </span>head</span>
<span id="cb22-8"><a href="#cb22-8"></a><span class="co">#&gt;    year month day dep_time sched_dep_time dep_delay arr_time</span></span>
<span id="cb22-9"><a href="#cb22-9"></a><span class="co">#&gt; 1: 2013     1   1      517            515         2      830</span></span>
<span id="cb22-10"><a href="#cb22-10"></a><span class="co">#&gt; 2: 2013     1   1      533            529         4      850</span></span>
<span id="cb22-11"><a href="#cb22-11"></a><span class="co">#&gt; 3: 2013     1   1      542            540         2      923</span></span>
<span id="cb22-12"><a href="#cb22-12"></a><span class="co">#&gt; 4: 2013     1   1      544            545        -1     1004</span></span>
<span id="cb22-13"><a href="#cb22-13"></a><span class="co">#&gt; 5: 2013     1   1      554            600        -6      812</span></span>
<span id="cb22-14"><a href="#cb22-14"></a><span class="co">#&gt; 6: 2013     1   1      554            558        -4      740</span></span>
<span id="cb22-15"><a href="#cb22-15"></a><span class="co">#&gt;    sched_arr_time arr_delay carrier flight tailnum origin dest air_time</span></span>
<span id="cb22-16"><a href="#cb22-16"></a><span class="co">#&gt; 1:            819        11      UA   1545  N14228    EWR  IAH      227</span></span>
<span id="cb22-17"><a href="#cb22-17"></a><span class="co">#&gt; 2:            830        20      UA   1714  N24211    LGA  IAH      227</span></span>
<span id="cb22-18"><a href="#cb22-18"></a><span class="co">#&gt; 3:            850        33      AA   1141  N619AA    JFK  MIA      160</span></span>
<span id="cb22-19"><a href="#cb22-19"></a><span class="co">#&gt; 4:           1022       -18      B6    725  N804JB    JFK  BQN      183</span></span>
<span id="cb22-20"><a href="#cb22-20"></a><span class="co">#&gt; 5:            837       -25      DL    461  N668DN    LGA  ATL      116</span></span>
<span id="cb22-21"><a href="#cb22-21"></a><span class="co">#&gt; 6:            728        12      UA   1696  N39463    EWR  ORD      150</span></span>
<span id="cb22-22"><a href="#cb22-22"></a><span class="co">#&gt;    distance hour minute            time_hour                   name</span></span>
<span id="cb22-23"><a href="#cb22-23"></a><span class="co">#&gt; 1:     1400    5     15 2013-01-01T10:00:00Z  United Air Lines Inc.</span></span>
<span id="cb22-24"><a href="#cb22-24"></a><span class="co">#&gt; 2:     1416    5     29 2013-01-01T10:00:00Z  United Air Lines Inc.</span></span>
<span id="cb22-25"><a href="#cb22-25"></a><span class="co">#&gt; 3:     1089    5     40 2013-01-01T10:00:00Z American Airlines Inc.</span></span>
<span id="cb22-26"><a href="#cb22-26"></a><span class="co">#&gt; 4:     1576    5     45 2013-01-01T10:00:00Z        JetBlue Airways</span></span>
<span id="cb22-27"><a href="#cb22-27"></a><span class="co">#&gt; 5:      762    6      0 2013-01-01T11:00:00Z   Delta Air Lines Inc.</span></span>
<span id="cb22-28"><a href="#cb22-28"></a><span class="co">#&gt; 6:      719    5     58 2013-01-01T10:00:00Z  United Air Lines Inc.</span></span></code></pre></div>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1"></a>flights.df <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb23-2"><a href="#cb23-2"></a><span class="st">  </span><span class="kw">left_join</span>(airlines.dt, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;carrier&quot;</span>, <span class="st">&quot;carrier&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb23-3"><a href="#cb23-3"></a><span class="st">  </span>collect <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb23-4"><a href="#cb23-4"></a><span class="st">  </span>tail</span>
<span id="cb23-5"><a href="#cb23-5"></a><span class="co">#&gt;    year month day dep_time sched_dep_time dep_delay arr_time</span></span>
<span id="cb23-6"><a href="#cb23-6"></a><span class="co">#&gt; 1: 2013     9  30       NA           1842        NA       NA</span></span>
<span id="cb23-7"><a href="#cb23-7"></a><span class="co">#&gt; 2: 2013     9  30       NA           1455        NA       NA</span></span>
<span id="cb23-8"><a href="#cb23-8"></a><span class="co">#&gt; 3: 2013     9  30       NA           2200        NA       NA</span></span>
<span id="cb23-9"><a href="#cb23-9"></a><span class="co">#&gt; 4: 2013     9  30       NA           1210        NA       NA</span></span>
<span id="cb23-10"><a href="#cb23-10"></a><span class="co">#&gt; 5: 2013     9  30       NA           1159        NA       NA</span></span>
<span id="cb23-11"><a href="#cb23-11"></a><span class="co">#&gt; 6: 2013     9  30       NA            840        NA       NA</span></span>
<span id="cb23-12"><a href="#cb23-12"></a><span class="co">#&gt;    sched_arr_time arr_delay carrier flight tailnum origin dest air_time</span></span>
<span id="cb23-13"><a href="#cb23-13"></a><span class="co">#&gt; 1:           2019        NA      EV   5274  N740EV    LGA  BNA       NA</span></span>
<span id="cb23-14"><a href="#cb23-14"></a><span class="co">#&gt; 2:           1634        NA      9E   3393            JFK  DCA       NA</span></span>
<span id="cb23-15"><a href="#cb23-15"></a><span class="co">#&gt; 3:           2312        NA      9E   3525            LGA  SYR       NA</span></span>
<span id="cb23-16"><a href="#cb23-16"></a><span class="co">#&gt; 4:           1330        NA      MQ   3461  N535MQ    LGA  BNA       NA</span></span>
<span id="cb23-17"><a href="#cb23-17"></a><span class="co">#&gt; 5:           1344        NA      MQ   3572  N511MQ    LGA  CLE       NA</span></span>
<span id="cb23-18"><a href="#cb23-18"></a><span class="co">#&gt; 6:           1020        NA      MQ   3531  N839MQ    LGA  RDU       NA</span></span>
<span id="cb23-19"><a href="#cb23-19"></a><span class="co">#&gt;    distance hour minute            time_hour                     name</span></span>
<span id="cb23-20"><a href="#cb23-20"></a><span class="co">#&gt; 1:      764   18     42 2013-09-30T22:00:00Z ExpressJet Airlines Inc.</span></span>
<span id="cb23-21"><a href="#cb23-21"></a><span class="co">#&gt; 2:      213   14     55 2013-09-30T18:00:00Z        Endeavor Air Inc.</span></span>
<span id="cb23-22"><a href="#cb23-22"></a><span class="co">#&gt; 3:      198   22      0 2013-10-01T02:00:00Z        Endeavor Air Inc.</span></span>
<span id="cb23-23"><a href="#cb23-23"></a><span class="co">#&gt; 4:      764   12     10 2013-09-30T16:00:00Z                Envoy Air</span></span>
<span id="cb23-24"><a href="#cb23-24"></a><span class="co">#&gt; 5:      419   11     59 2013-09-30T15:00:00Z                Envoy Air</span></span>
<span id="cb23-25"><a href="#cb23-25"></a><span class="co">#&gt; 6:      431    8     40 2013-09-30T12:00:00Z                Envoy Air</span></span></code></pre></div>
</div>
<div id="window-functions-and-arbitrary-functions" class="section level2">
<h2>Window functions and arbitrary functions</h2>
<p><code>disk.frame</code> supports all <code>data.frame</code> operations, unlike Spark which can only perform those operations that Spark has implemented. Hence windowing functions like <code>rank</code> are supported out of the box.</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1"></a><span class="co"># Find the most and least delayed flight each day</span></span>
<span id="cb24-2"><a href="#cb24-2"></a>bestworst &lt;-<span class="st"> </span>flights.df <span class="op">%&gt;%</span></span>
<span id="cb24-3"><a href="#cb24-3"></a><span class="st">   </span><span class="kw">srckeep</span>(<span class="kw">c</span>(<span class="st">&quot;year&quot;</span>,<span class="st">&quot;month&quot;</span>,<span class="st">&quot;day&quot;</span>, <span class="st">&quot;dep_delay&quot;</span>)) <span class="op">%&gt;%</span></span>
<span id="cb24-4"><a href="#cb24-4"></a><span class="st">   </span><span class="kw">chunk_group_by</span>(year, month, day) <span class="op">%&gt;%</span></span>
<span id="cb24-5"><a href="#cb24-5"></a><span class="st">   </span><span class="kw">select</span>(dep_delay) <span class="op">%&gt;%</span></span>
<span id="cb24-6"><a href="#cb24-6"></a><span class="st">   </span><span class="kw">filter</span>(dep_delay <span class="op">==</span><span class="st"> </span><span class="kw">min</span>(dep_delay, <span class="dt">na.rm =</span> T) <span class="op">||</span><span class="st"> </span>dep_delay <span class="op">==</span><span class="st"> </span><span class="kw">max</span>(dep_delay, <span class="dt">na.rm =</span> T)) <span class="op">%&gt;%</span></span>
<span id="cb24-7"><a href="#cb24-7"></a><span class="st">   </span>collect</span>
<span id="cb24-8"><a href="#cb24-8"></a><span class="co">#&gt; Adding missing grouping variables: `year`, `month`, `day`</span></span>
<span id="cb24-9"><a href="#cb24-9"></a><span class="co">#&gt; Warning in min(dep_delay, na.rm = T): no non-missing arguments to min;</span></span>
<span id="cb24-10"><a href="#cb24-10"></a><span class="co">#&gt; returning Inf</span></span>
<span id="cb24-11"><a href="#cb24-11"></a><span class="co">#&gt; Warning in max(dep_delay, na.rm = T): no non-missing arguments to max;</span></span>
<span id="cb24-12"><a href="#cb24-12"></a><span class="co">#&gt; returning -Inf</span></span>
<span id="cb24-13"><a href="#cb24-13"></a><span class="co">#&gt; Adding missing grouping variables: `year`, `month`, `day`</span></span>
<span id="cb24-14"><a href="#cb24-14"></a><span class="co">#&gt; Adding missing grouping variables: `year`, `month`, `day`</span></span>
<span id="cb24-15"><a href="#cb24-15"></a><span class="co">#&gt; Adding missing grouping variables: `year`, `month`, `day`</span></span>
<span id="cb24-16"><a href="#cb24-16"></a><span class="co">#&gt; Adding missing grouping variables: `year`, `month`, `day`</span></span>
<span id="cb24-17"><a href="#cb24-17"></a><span class="co">#&gt; Adding missing grouping variables: `year`, `month`, `day`</span></span>
<span id="cb24-18"><a href="#cb24-18"></a>   </span>
<span id="cb24-19"><a href="#cb24-19"></a></span>
<span id="cb24-20"><a href="#cb24-20"></a>bestworst <span class="op">%&gt;%</span><span class="st"> </span>head</span>
<span id="cb24-21"><a href="#cb24-21"></a><span class="co">#&gt; # A tibble: 6 x 4</span></span>
<span id="cb24-22"><a href="#cb24-22"></a><span class="co">#&gt; # Groups:   year, month, day [1]</span></span>
<span id="cb24-23"><a href="#cb24-23"></a><span class="co">#&gt;    year month   day dep_delay</span></span>
<span id="cb24-24"><a href="#cb24-24"></a><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;     &lt;int&gt;</span></span>
<span id="cb24-25"><a href="#cb24-25"></a><span class="co">#&gt; 1  2013     2     7       148</span></span>
<span id="cb24-26"><a href="#cb24-26"></a><span class="co">#&gt; 2  2013     2     7        -2</span></span>
<span id="cb24-27"><a href="#cb24-27"></a><span class="co">#&gt; 3  2013     2     7         1</span></span>
<span id="cb24-28"><a href="#cb24-28"></a><span class="co">#&gt; 4  2013     2     7         6</span></span>
<span id="cb24-29"><a href="#cb24-29"></a><span class="co">#&gt; 5  2013     2     7        -2</span></span>
<span id="cb24-30"><a href="#cb24-30"></a><span class="co">#&gt; 6  2013     2     7        -2</span></span></code></pre></div>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1"></a><span class="co"># Rank each flight within a daily</span></span>
<span id="cb25-2"><a href="#cb25-2"></a>ranked &lt;-<span class="st"> </span>flights.df <span class="op">%&gt;%</span></span>
<span id="cb25-3"><a href="#cb25-3"></a><span class="st">  </span><span class="kw">srckeep</span>(<span class="kw">c</span>(<span class="st">&quot;year&quot;</span>,<span class="st">&quot;month&quot;</span>,<span class="st">&quot;day&quot;</span>, <span class="st">&quot;dep_delay&quot;</span>)) <span class="op">%&gt;%</span></span>
<span id="cb25-4"><a href="#cb25-4"></a><span class="st">  </span><span class="kw">chunk_group_by</span>(year, month, day) <span class="op">%&gt;%</span></span>
<span id="cb25-5"><a href="#cb25-5"></a><span class="st">  </span><span class="kw">select</span>(dep_delay) <span class="op">%&gt;%</span></span>
<span id="cb25-6"><a href="#cb25-6"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">rank =</span> <span class="kw">rank</span>(<span class="kw">desc</span>(dep_delay))) <span class="op">%&gt;%</span></span>
<span id="cb25-7"><a href="#cb25-7"></a><span class="st">  </span>collect</span>
<span id="cb25-8"><a href="#cb25-8"></a><span class="co">#&gt; Adding missing grouping variables: `year`, `month`, `day`</span></span>
<span id="cb25-9"><a href="#cb25-9"></a><span class="co">#&gt; Adding missing grouping variables: `year`, `month`, `day`</span></span>
<span id="cb25-10"><a href="#cb25-10"></a><span class="co">#&gt; Adding missing grouping variables: `year`, `month`, `day`</span></span>
<span id="cb25-11"><a href="#cb25-11"></a><span class="co">#&gt; Adding missing grouping variables: `year`, `month`, `day`</span></span>
<span id="cb25-12"><a href="#cb25-12"></a><span class="co">#&gt; Adding missing grouping variables: `year`, `month`, `day`</span></span>
<span id="cb25-13"><a href="#cb25-13"></a><span class="co">#&gt; Adding missing grouping variables: `year`, `month`, `day`</span></span>
<span id="cb25-14"><a href="#cb25-14"></a></span>
<span id="cb25-15"><a href="#cb25-15"></a>ranked <span class="op">%&gt;%</span><span class="st"> </span>head</span>
<span id="cb25-16"><a href="#cb25-16"></a><span class="co">#&gt; # A tibble: 6 x 5</span></span>
<span id="cb25-17"><a href="#cb25-17"></a><span class="co">#&gt; # Groups:   year, month, day [1]</span></span>
<span id="cb25-18"><a href="#cb25-18"></a><span class="co">#&gt;    year month   day dep_delay  rank</span></span>
<span id="cb25-19"><a href="#cb25-19"></a><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;     &lt;int&gt; &lt;dbl&gt;</span></span>
<span id="cb25-20"><a href="#cb25-20"></a><span class="co">#&gt; 1  2013     1     1         2   313</span></span>
<span id="cb25-21"><a href="#cb25-21"></a><span class="co">#&gt; 2  2013     1     1         4   276</span></span>
<span id="cb25-22"><a href="#cb25-22"></a><span class="co">#&gt; 3  2013     1     1         2   313</span></span>
<span id="cb25-23"><a href="#cb25-23"></a><span class="co">#&gt; 4  2013     1     1        -1   440</span></span>
<span id="cb25-24"><a href="#cb25-24"></a><span class="co">#&gt; 5  2013     1     1        -6   742</span></span>
<span id="cb25-25"><a href="#cb25-25"></a><span class="co">#&gt; 6  2013     1     1        -4   633</span></span></code></pre></div>
</div>
<div id="arbitrary-by-chunk-processing" class="section level2">
<h2>Arbitrary by-chunk processing</h2>
<p>One can apply arbitrary transformations to each chunk of the <code>disk.frame</code> by using the <code>delayed</code> function which evaluates lazily or the <code>map.disk.frame(lazy = F)</code> function which evaluates eagerly. For example to return the number of rows in each chunk</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1"></a>flights.df1 &lt;-<span class="st"> </span><span class="kw">delayed</span>(flights.df, <span class="op">~</span><span class="kw">nrow</span>(.x))</span>
<span id="cb26-2"><a href="#cb26-2"></a><span class="kw">collect_list</span>(flights.df1) <span class="op">%&gt;%</span><span class="st"> </span>head <span class="co"># returns number of rows for each data.frame in a list</span></span>
<span id="cb26-3"><a href="#cb26-3"></a><span class="co">#&gt; [[1]]</span></span>
<span id="cb26-4"><a href="#cb26-4"></a><span class="co">#&gt; [1] 56131</span></span>
<span id="cb26-5"><a href="#cb26-5"></a><span class="co">#&gt; </span></span>
<span id="cb26-6"><a href="#cb26-6"></a><span class="co">#&gt; [[2]]</span></span>
<span id="cb26-7"><a href="#cb26-7"></a><span class="co">#&gt; [1] 56131</span></span>
<span id="cb26-8"><a href="#cb26-8"></a><span class="co">#&gt; </span></span>
<span id="cb26-9"><a href="#cb26-9"></a><span class="co">#&gt; [[3]]</span></span>
<span id="cb26-10"><a href="#cb26-10"></a><span class="co">#&gt; [1] 56131</span></span>
<span id="cb26-11"><a href="#cb26-11"></a><span class="co">#&gt; </span></span>
<span id="cb26-12"><a href="#cb26-12"></a><span class="co">#&gt; [[4]]</span></span>
<span id="cb26-13"><a href="#cb26-13"></a><span class="co">#&gt; [1] 56131</span></span>
<span id="cb26-14"><a href="#cb26-14"></a><span class="co">#&gt; </span></span>
<span id="cb26-15"><a href="#cb26-15"></a><span class="co">#&gt; [[5]]</span></span>
<span id="cb26-16"><a href="#cb26-16"></a><span class="co">#&gt; [1] 56131</span></span>
<span id="cb26-17"><a href="#cb26-17"></a><span class="co">#&gt; </span></span>
<span id="cb26-18"><a href="#cb26-18"></a><span class="co">#&gt; [[6]]</span></span>
<span id="cb26-19"><a href="#cb26-19"></a><span class="co">#&gt; [1] 56121</span></span></code></pre></div>
<p>and to do the same with <code>map.disk.frame</code></p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1"></a><span class="kw">map</span>(flights.df, <span class="op">~</span><span class="kw">nrow</span>(.x), <span class="dt">lazy =</span> F) <span class="op">%&gt;%</span><span class="st"> </span>head</span>
<span id="cb27-2"><a href="#cb27-2"></a><span class="co">#&gt; [[1]]</span></span>
<span id="cb27-3"><a href="#cb27-3"></a><span class="co">#&gt; [1] 56131</span></span>
<span id="cb27-4"><a href="#cb27-4"></a><span class="co">#&gt; </span></span>
<span id="cb27-5"><a href="#cb27-5"></a><span class="co">#&gt; [[2]]</span></span>
<span id="cb27-6"><a href="#cb27-6"></a><span class="co">#&gt; [1] 56131</span></span>
<span id="cb27-7"><a href="#cb27-7"></a><span class="co">#&gt; </span></span>
<span id="cb27-8"><a href="#cb27-8"></a><span class="co">#&gt; [[3]]</span></span>
<span id="cb27-9"><a href="#cb27-9"></a><span class="co">#&gt; [1] 56131</span></span>
<span id="cb27-10"><a href="#cb27-10"></a><span class="co">#&gt; </span></span>
<span id="cb27-11"><a href="#cb27-11"></a><span class="co">#&gt; [[4]]</span></span>
<span id="cb27-12"><a href="#cb27-12"></a><span class="co">#&gt; [1] 56131</span></span>
<span id="cb27-13"><a href="#cb27-13"></a><span class="co">#&gt; </span></span>
<span id="cb27-14"><a href="#cb27-14"></a><span class="co">#&gt; [[5]]</span></span>
<span id="cb27-15"><a href="#cb27-15"></a><span class="co">#&gt; [1] 56131</span></span>
<span id="cb27-16"><a href="#cb27-16"></a><span class="co">#&gt; </span></span>
<span id="cb27-17"><a href="#cb27-17"></a><span class="co">#&gt; [[6]]</span></span>
<span id="cb27-18"><a href="#cb27-18"></a><span class="co">#&gt; [1] 56121</span></span></code></pre></div>
<p>The <code>map</code> function can also output the results to another disk.frame folder, e.g.</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1"></a><span class="co"># return the first 10 rows of each chunk</span></span>
<span id="cb28-2"><a href="#cb28-2"></a>flights.df2 &lt;-<span class="st"> </span><span class="kw">map</span>(flights.df, <span class="op">~</span>.x[<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>,], <span class="dt">lazy =</span> F, <span class="dt">outdir =</span> <span class="kw">file.path</span>(<span class="kw">tempdir</span>(), <span class="st">&quot;tmp2&quot;</span>), <span class="dt">overwrite =</span> T)</span>
<span id="cb28-3"><a href="#cb28-3"></a></span>
<span id="cb28-4"><a href="#cb28-4"></a>flights.df2 <span class="op">%&gt;%</span><span class="st"> </span>head</span>
<span id="cb28-5"><a href="#cb28-5"></a><span class="co">#&gt;    year month day dep_time sched_dep_time dep_delay arr_time</span></span>
<span id="cb28-6"><a href="#cb28-6"></a><span class="co">#&gt; 1: 2013     1   1      517            515         2      830</span></span>
<span id="cb28-7"><a href="#cb28-7"></a><span class="co">#&gt; 2: 2013     1   1      533            529         4      850</span></span>
<span id="cb28-8"><a href="#cb28-8"></a><span class="co">#&gt; 3: 2013     1   1      542            540         2      923</span></span>
<span id="cb28-9"><a href="#cb28-9"></a><span class="co">#&gt; 4: 2013     1   1      544            545        -1     1004</span></span>
<span id="cb28-10"><a href="#cb28-10"></a><span class="co">#&gt; 5: 2013     1   1      554            600        -6      812</span></span>
<span id="cb28-11"><a href="#cb28-11"></a><span class="co">#&gt; 6: 2013     1   1      554            558        -4      740</span></span>
<span id="cb28-12"><a href="#cb28-12"></a><span class="co">#&gt;    sched_arr_time arr_delay carrier flight tailnum origin dest air_time</span></span>
<span id="cb28-13"><a href="#cb28-13"></a><span class="co">#&gt; 1:            819        11      UA   1545  N14228    EWR  IAH      227</span></span>
<span id="cb28-14"><a href="#cb28-14"></a><span class="co">#&gt; 2:            830        20      UA   1714  N24211    LGA  IAH      227</span></span>
<span id="cb28-15"><a href="#cb28-15"></a><span class="co">#&gt; 3:            850        33      AA   1141  N619AA    JFK  MIA      160</span></span>
<span id="cb28-16"><a href="#cb28-16"></a><span class="co">#&gt; 4:           1022       -18      B6    725  N804JB    JFK  BQN      183</span></span>
<span id="cb28-17"><a href="#cb28-17"></a><span class="co">#&gt; 5:            837       -25      DL    461  N668DN    LGA  ATL      116</span></span>
<span id="cb28-18"><a href="#cb28-18"></a><span class="co">#&gt; 6:            728        12      UA   1696  N39463    EWR  ORD      150</span></span>
<span id="cb28-19"><a href="#cb28-19"></a><span class="co">#&gt;    distance hour minute            time_hour</span></span>
<span id="cb28-20"><a href="#cb28-20"></a><span class="co">#&gt; 1:     1400    5     15 2013-01-01T10:00:00Z</span></span>
<span id="cb28-21"><a href="#cb28-21"></a><span class="co">#&gt; 2:     1416    5     29 2013-01-01T10:00:00Z</span></span>
<span id="cb28-22"><a href="#cb28-22"></a><span class="co">#&gt; 3:     1089    5     40 2013-01-01T10:00:00Z</span></span>
<span id="cb28-23"><a href="#cb28-23"></a><span class="co">#&gt; 4:     1576    5     45 2013-01-01T10:00:00Z</span></span>
<span id="cb28-24"><a href="#cb28-24"></a><span class="co">#&gt; 5:      762    6      0 2013-01-01T11:00:00Z</span></span>
<span id="cb28-25"><a href="#cb28-25"></a><span class="co">#&gt; 6:      719    5     58 2013-01-01T10:00:00Z</span></span></code></pre></div>
<p>Notice <code>disk.frame</code> supports the <code>purrr</code> syntax for defining a function using <code>~</code>.</p>
</div>
<div id="sampling" class="section level2">
<h2>Sampling</h2>
<p>In the <code>disk.frame</code> framework, sampling a proportion of rows within each chunk can be performed using <code>sample_frac</code>.</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1"></a>flights.df <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">sample_frac</span>(<span class="fl">0.01</span>) <span class="op">%&gt;%</span><span class="st"> </span>collect <span class="op">%&gt;%</span><span class="st"> </span>head</span>
<span id="cb29-2"><a href="#cb29-2"></a><span class="co">#&gt;   year month day dep_time sched_dep_time dep_delay arr_time sched_arr_time</span></span>
<span id="cb29-3"><a href="#cb29-3"></a><span class="co">#&gt; 1 2013     8  24     1306           1300         6     1526           1534</span></span>
<span id="cb29-4"><a href="#cb29-4"></a><span class="co">#&gt; 2 2013     5  10     1423           1359        24     1646           1631</span></span>
<span id="cb29-5"><a href="#cb29-5"></a><span class="co">#&gt; 3 2013     5  15     1705           1603        62     1815           1730</span></span>
<span id="cb29-6"><a href="#cb29-6"></a><span class="co">#&gt; 4 2013     1  12     1855           1855         0     2142           2212</span></span>
<span id="cb29-7"><a href="#cb29-7"></a><span class="co">#&gt; 5 2013     8  25     1425           1430        -5     1620           1613</span></span>
<span id="cb29-8"><a href="#cb29-8"></a><span class="co">#&gt; 6 2013     5  12      850            850         0     1230           1248</span></span>
<span id="cb29-9"><a href="#cb29-9"></a><span class="co">#&gt;   arr_delay carrier flight tailnum origin dest air_time distance hour</span></span>
<span id="cb29-10"><a href="#cb29-10"></a><span class="co">#&gt; 1        -8      DL    781  N943DL    LGA  ATL      109      762   13</span></span>
<span id="cb29-11"><a href="#cb29-11"></a><span class="co">#&gt; 2        15      DL   2043  N343NB    JFK  ATL      111      760   13</span></span>
<span id="cb29-12"><a href="#cb29-12"></a><span class="co">#&gt; 3        45      YV   3791  N519LR    LGA  IAD       48      229   16</span></span>
<span id="cb29-13"><a href="#cb29-13"></a><span class="co">#&gt; 4       -30      DL   2391  N915DL    JFK  TPA      139     1005   18</span></span>
<span id="cb29-14"><a href="#cb29-14"></a><span class="co">#&gt; 5         7      EV   4548  N15574    EWR  RDU       72      416   14</span></span>
<span id="cb29-15"><a href="#cb29-15"></a><span class="co">#&gt; 6       -18      DL    301   N3759    JFK  SJU      192     1598    8</span></span>
<span id="cb29-16"><a href="#cb29-16"></a><span class="co">#&gt;   minute            time_hour</span></span>
<span id="cb29-17"><a href="#cb29-17"></a><span class="co">#&gt; 1      0 2013-08-24T17:00:00Z</span></span>
<span id="cb29-18"><a href="#cb29-18"></a><span class="co">#&gt; 2     59 2013-05-10T17:00:00Z</span></span>
<span id="cb29-19"><a href="#cb29-19"></a><span class="co">#&gt; 3      3 2013-05-15T20:00:00Z</span></span>
<span id="cb29-20"><a href="#cb29-20"></a><span class="co">#&gt; 4     55 2013-01-12T23:00:00Z</span></span>
<span id="cb29-21"><a href="#cb29-21"></a><span class="co">#&gt; 5     30 2013-08-25T18:00:00Z</span></span>
<span id="cb29-22"><a href="#cb29-22"></a><span class="co">#&gt; 6     50 2013-05-12T12:00:00Z</span></span></code></pre></div>
</div>
<div id="writing-data" class="section level2">
<h2>Writing Data</h2>
<p>One can output a <code>disk.frame</code> by using the <code>write_disk.frame</code> function. E.g.</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1"></a><span class="kw">write_disk.frame</span>(flights.df, <span class="dt">outdir=</span><span class="st">&quot;out&quot;</span>)</span></code></pre></div>
<p>this will output a disk.frame to the folder “out”</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1"></a>fs<span class="op">::</span><span class="kw">dir_delete</span>(<span class="kw">file.path</span>(<span class="kw">tempdir</span>(), <span class="st">&quot;tmp_flights.df&quot;</span>))</span>
<span id="cb31-2"><a href="#cb31-2"></a>fs<span class="op">::</span><span class="kw">dir_delete</span>(<span class="kw">file.path</span>(<span class="kw">tempdir</span>(), <span class="st">&quot;tmp2&quot;</span>))</span>
<span id="cb31-3"><a href="#cb31-3"></a>fs<span class="op">::</span><span class="kw">file_delete</span>(<span class="kw">file.path</span>(<span class="kw">tempdir</span>(), <span class="st">&quot;tmp_flights.csv&quot;</span>))</span></code></pre></div>
</div>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
