<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1">

<meta name="author" content="ZJ" />


<title>Quick Start: Basic Operations with nycflights13</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>



<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#header {
text-align: center;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; }  code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Quick Start: Basic Operations with nycflights13</h1>
<h4 class="author">ZJ</h4>



<div id="quick-start---replicating-dplyrs-tutorial-on-nycflight13" class="section level1">
<h1>Quick Start - replicating dplyr’s tutorial on nycflight13</h1>
<p>The <a href="https://github.com/xiaodaigh/disk.frame"><code>disk.frame</code> package</a> aims to be the answer to the question: how do I manipulate structured tabular data that doesn’t fit into Random Access Memory (RAM)?</p>
<p>In a nutshell, <code>disk.frame</code> makes use of two simple ideas</p>
<ol style="list-style-type: decimal">
<li>split up a larger-than-RAM dataset into chunks and store each chunk in a separate file inside a folder and</li>
<li>provide a convenient API to manipulate these chunks</li>
</ol>
<p><code>disk.frame</code> performs a similar role to distributed systems such as Apache Spark, Python’s Dask, and Julia’s JuliaDB.jl for <em>medium data</em> which are datasets that are too large for RAM but not quite large enough to qualify as <em>big data</em>.</p>
<p>In this tutorial, we introduce <code>disk.frame</code>, address some common questions, and replicate the <a href="https://spark.rstudio.com/dplyr/">sparklyr data manipulation tutorial</a> using <code>disk.frame</code> constructs.</p>
<div id="installation" class="section level2">
<h2>Installation</h2>
<p>Simply run</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" title="1"><span class="kw">install.packages</span>(<span class="st">&quot;disk.frame&quot;</span>) <span class="co"># when CRAN ready</span></a></code></pre></div>
<p>or</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" title="1">devtools<span class="op">::</span><span class="kw">install_github</span>(<span class="st">&quot;xiaodaigh/disk.frame&quot;</span>)</a></code></pre></div>
</div>
<div id="set-up-disk.frame" class="section level2">
<h2>Set-up <code>disk.frame</code></h2>
<p><code>disk.frame</code> works best if it can process multiple data chunks in parallel. The best way to set-up <code>disk.frame</code> so that each CPU core runs a background worker is by using</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" title="1"><span class="kw">setup_disk.frame</span>()</a>
<a class="sourceLine" id="cb3-2" title="2"></a>
<a class="sourceLine" id="cb3-3" title="3"><span class="co"># this will allow unlimited amount of data to be passed from worker to worker</span></a>
<a class="sourceLine" id="cb3-4" title="4"><span class="kw">options</span>(<span class="dt">future.globals.maxSize =</span> <span class="ot">Inf</span>)</a></code></pre></div>
<p>The <code>setup_disk.frame()</code> sets up background workers equal to the number of CPU cores; please note that, by default, hyper-threaded cores are counted as one not two.</p>
<p>Alternatively, one may specify the number of workers using <code>setup_disk.frame(workers = n)</code>.</p>
</div>
<div id="basic-data-operations-with-disk.frame" class="section level2">
<h2>Basic Data Operations with <code>disk.frame</code></h2>
<p>The <code>disk.frame</code> package provides convenient functions to convert <code>data.frame</code>s and CSVs to <code>disk.frame</code>s.</p>
<div id="creating-a-disk.frame-from-data.frame" class="section level3">
<h3>Creating a <code>disk.frame</code> from <code>data.frame</code></h3>
<p>We convert a <code>data.frame</code> to <code>disk.frame</code> using the <code>as.data.frame</code> function.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" title="1"><span class="kw">library</span>(nycflights13)</a>
<a class="sourceLine" id="cb4-2" title="2"><span class="kw">library</span>(dplyr)</a>
<a class="sourceLine" id="cb4-3" title="3"><span class="kw">library</span>(disk.frame)</a>
<a class="sourceLine" id="cb4-4" title="4"><span class="kw">library</span>(data.table)</a>
<a class="sourceLine" id="cb4-5" title="5"></a>
<a class="sourceLine" id="cb4-6" title="6"><span class="co"># convert the flights data to a disk.frame and store the disk.frame in the folder</span></a>
<a class="sourceLine" id="cb4-7" title="7"><span class="co"># &quot;tmp_flights&quot; and overwrite any content if needed</span></a>
<a class="sourceLine" id="cb4-8" title="8">flights.df &lt;-<span class="st"> </span><span class="kw">as.disk.frame</span>(</a>
<a class="sourceLine" id="cb4-9" title="9">  flights, </a>
<a class="sourceLine" id="cb4-10" title="10">  <span class="dt">outdir =</span> <span class="kw">file.path</span>(<span class="kw">tempdir</span>(), <span class="st">&quot;tmp_flights.df&quot;</span>),</a>
<a class="sourceLine" id="cb4-11" title="11">  <span class="dt">overwrite =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb4-12" title="12">flights.df</a></code></pre></div>
<p>You should now see a folder called <code>tmp_flights</code> with some files in it, namely <code>1.fst</code>, <code>2.fst</code>…. where each <code>fst</code> files is one chunk of the <code>disk.frame</code>.</p>
</div>
<div id="creating-a-disk.frame-from-csv" class="section level3">
<h3>Creating a <code>disk.frame</code> from CSV</h3>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" title="1"><span class="kw">library</span>(nycflights13)</a>
<a class="sourceLine" id="cb5-2" title="2"><span class="co"># write a csv</span></a>
<a class="sourceLine" id="cb5-3" title="3">csv_path =<span class="st"> </span><span class="kw">file.path</span>(<span class="kw">tempdir</span>(), <span class="st">&quot;tmp_flights.csv&quot;</span>)</a>
<a class="sourceLine" id="cb5-4" title="4">data.table<span class="op">::</span><span class="kw">fwrite</span>(flights, csv_path)</a>
<a class="sourceLine" id="cb5-5" title="5"></a>
<a class="sourceLine" id="cb5-6" title="6"><span class="co"># load the csv into a disk.frame</span></a>
<a class="sourceLine" id="cb5-7" title="7">df_path =<span class="st"> </span><span class="kw">file.path</span>(<span class="kw">tempdir</span>(), <span class="st">&quot;tmp_flights.df&quot;</span>)</a>
<a class="sourceLine" id="cb5-8" title="8">flights.df &lt;-<span class="st"> </span><span class="kw">csv_to_disk.frame</span>(</a>
<a class="sourceLine" id="cb5-9" title="9">  csv_path, </a>
<a class="sourceLine" id="cb5-10" title="10">  <span class="dt">outdir =</span> df_path,</a>
<a class="sourceLine" id="cb5-11" title="11">  <span class="dt">overwrite =</span> T)</a>
<a class="sourceLine" id="cb5-12" title="12">  </a>
<a class="sourceLine" id="cb5-13" title="13">flights.df</a></code></pre></div>
<p>If the CSV is too large to read in, then we can also use the <code>in_chunk_size</code> option to control how many rows to read in at once. For example to read in the data 100,000 rows at a time.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" title="1"><span class="kw">library</span>(nycflights13)</a>
<a class="sourceLine" id="cb6-2" title="2"><span class="kw">library</span>(disk.frame)</a>
<a class="sourceLine" id="cb6-3" title="3"></a>
<a class="sourceLine" id="cb6-4" title="4"><span class="co"># write a csv</span></a>
<a class="sourceLine" id="cb6-5" title="5">csv_path =<span class="st"> </span><span class="kw">file.path</span>(<span class="kw">tempdir</span>(), <span class="st">&quot;tmp_flights.csv&quot;</span>)</a>
<a class="sourceLine" id="cb6-6" title="6"></a>
<a class="sourceLine" id="cb6-7" title="7">data.table<span class="op">::</span><span class="kw">fwrite</span>(flights, csv_path)</a>
<a class="sourceLine" id="cb6-8" title="8"></a>
<a class="sourceLine" id="cb6-9" title="9">df_path =<span class="st"> </span><span class="kw">file.path</span>(<span class="kw">tempdir</span>(), <span class="st">&quot;tmp_flights.df&quot;</span>)</a>
<a class="sourceLine" id="cb6-10" title="10"></a>
<a class="sourceLine" id="cb6-11" title="11">flights.df &lt;-<span class="st"> </span><span class="kw">csv_to_disk.frame</span>(</a>
<a class="sourceLine" id="cb6-12" title="12">  csv_path, </a>
<a class="sourceLine" id="cb6-13" title="13">  <span class="dt">outdir =</span> df_path, </a>
<a class="sourceLine" id="cb6-14" title="14">  <span class="dt">in_chunk_size =</span> <span class="dv">100000</span>)</a>
<a class="sourceLine" id="cb6-15" title="15">  </a>
<a class="sourceLine" id="cb6-16" title="16">flights.df</a></code></pre></div>
<p><code>disk.frame</code> also has a function <code>zip_to_disk.frame</code> that can convert every CSV in a zip file to <code>disk.frame</code>s.</p>
</div>
<div id="simple-dplyr-verbs-and-lazy-evaluation" class="section level3">
<h3>Simple <code>dplyr</code> verbs and lazy evaluation</h3>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" title="1">flights.df1 &lt;-<span class="st"> </span><span class="kw">select</span>(flights.df, year<span class="op">:</span>day, arr_delay, dep_delay)</a>
<a class="sourceLine" id="cb7-2" title="2">flights.df1</a></code></pre></div>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" title="1"><span class="kw">class</span>(flights.df1)</a></code></pre></div>
<p>The class of <code>flights.df1</code> is also a <code>disk.frame</code> after the <code>dplyr::select</code> transformation. Also, <code>disk.frame</code> operations are by default (and where possible) <strong>lazy</strong>, meaning it doesn’t perform the operations right away. Instead, it waits until you call <code>collect</code>. Exceptions to this rule are the <code>*_join</code> operations which evaluated <em>eagerly</em> under certain conditions see <strong>Joins for disk.frame in-depth</strong> for details.</p>
<p>For lazily constructed <code>disk.frame</code>s (e.g. <code>flights.df1</code>). The function <code>collect</code> can be used to bring the results from disk into R, e.g.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" title="1"><span class="kw">collect</span>(flights.df1) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">head</span>(<span class="dv">2</span>)</a></code></pre></div>
<p>Of course, for larger-than-RAM datasets, one wouldn’t call <code>collect</code> on the whole <code>disk.frame</code> (because why would you need <code>disk.frame</code> otherwise). More likely, one would call <code>collect</code> on a <code>filter</code>ed dataset or one summarized with <code>group_by</code>.</p>
<p>Some examples of other dplyr verbs applied:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" title="1"><span class="kw">filter</span>(flights.df, dep_delay <span class="op">&gt;</span><span class="st"> </span><span class="dv">1000</span>) <span class="op">%&gt;%</span><span class="st"> </span>collect <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">head</span>(<span class="dv">2</span>)</a></code></pre></div>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" title="1"><span class="kw">mutate</span>(flights.df, <span class="dt">speed =</span> distance <span class="op">/</span><span class="st"> </span>air_time <span class="op">*</span><span class="st"> </span><span class="dv">60</span>) <span class="op">%&gt;%</span><span class="st"> </span>collect <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">head</span>(<span class="dv">2</span>)</a></code></pre></div>
</div>
<div id="examples-of-not-fully-supported-dplyr-verbs" class="section level3">
<h3>Examples of NOT fully supported <code>dplyr</code> verbs</h3>
<p>The <code>chunk_arrange</code> function arranges (sorts) each chunk but not the whole dataset. So use with caution. Similarly <code>chunk_summarise</code> creates summary variables within each chunk and hence also needs to be used with caution. In the Group By section, we demonstrate how to use <code>summarise</code> in the <code>disk.frame</code> context correctly with <code>hard_group_by</code>s.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" title="1"><span class="co"># this only sorts within each chunk</span></a>
<a class="sourceLine" id="cb12-2" title="2"><span class="kw">chunk_arrange</span>(flights.df, dplyr<span class="op">::</span><span class="kw">desc</span>(dep_delay)) <span class="op">%&gt;%</span><span class="st"> </span>collect <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">head</span>(<span class="dv">2</span>)</a></code></pre></div>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" title="1"><span class="kw">chunk_summarize</span>(flights.df, <span class="dt">mean_dep_delay =</span> <span class="kw">mean</span>(dep_delay, <span class="dt">na.rm =</span>T)) <span class="op">%&gt;%</span><span class="st"> </span>collect</a></code></pre></div>
</div>
<div id="piping" class="section level3">
<h3>Piping</h3>
<p>One can chain <code>dplyr</code> verbs together like with a <code>data.frame</code></p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" title="1">c4 &lt;-<span class="st"> </span>flights <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb14-2" title="2"><span class="st">  </span><span class="kw">filter</span>(month <span class="op">==</span><span class="st"> </span><span class="dv">5</span>, day <span class="op">==</span><span class="st"> </span><span class="dv">17</span>, carrier <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&#39;UA&#39;</span>, <span class="st">&#39;WN&#39;</span>, <span class="st">&#39;AA&#39;</span>, <span class="st">&#39;DL&#39;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb14-3" title="3"><span class="st">  </span><span class="kw">select</span>(carrier, dep_delay, air_time, distance) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb14-4" title="4"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">air_time_hours =</span> air_time <span class="op">/</span><span class="st"> </span><span class="dv">60</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb14-5" title="5"><span class="st">  </span>collect <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb14-6" title="6"><span class="st">  </span><span class="kw">arrange</span>(carrier)<span class="co"># arrange should occur after `collect`</span></a>
<a class="sourceLine" id="cb14-7" title="7"></a>
<a class="sourceLine" id="cb14-8" title="8">c4  <span class="op">%&gt;%</span><span class="st"> </span>head</a></code></pre></div>
</div>
<div id="list-of-supported-dplyr-verbs" class="section level3">
<h3>List of supported <code>dplyr</code> verbs</h3>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" title="1">select</a>
<a class="sourceLine" id="cb15-2" title="2">rename</a>
<a class="sourceLine" id="cb15-3" title="3">filter</a>
<a class="sourceLine" id="cb15-4" title="4">chunk_arrange <span class="co"># within each chunk</span></a>
<a class="sourceLine" id="cb15-5" title="5">chunk_group_by <span class="co"># within each chunk</span></a>
<a class="sourceLine" id="cb15-6" title="6">chunk_summarize <span class="co"># within each chunk</span></a>
<a class="sourceLine" id="cb15-7" title="7">group_by <span class="co"># limited functions</span></a>
<a class="sourceLine" id="cb15-8" title="8">summarize <span class="co"># limited functions</span></a>
<a class="sourceLine" id="cb15-9" title="9">mutate</a>
<a class="sourceLine" id="cb15-10" title="10">transmute</a>
<a class="sourceLine" id="cb15-11" title="11">left_join</a>
<a class="sourceLine" id="cb15-12" title="12">inner_join</a>
<a class="sourceLine" id="cb15-13" title="13">full_join <span class="co"># careful. Performance!</span></a>
<a class="sourceLine" id="cb15-14" title="14">semi_join</a>
<a class="sourceLine" id="cb15-15" title="15">anit_join</a></code></pre></div>
</div>
</div>
<div id="sharding-and-distribution-of-chunks" class="section level2">
<h2>Sharding and distribution of chunks</h2>
<p>Like other distributed data manipulation frameworks <code>disk.frame</code> utilizes the <em>sharding</em> concept to distribute the data into chunks. For example “to shard by <code>cust_id</code>” means that all rows with the same <code>cust_id</code> will be stored in the same chunk. This enables <code>chunk_group_by</code> by <code>cust_id</code> to produce the same results as non-chunked data.</p>
<p>The <code>by</code> variables that were used to shard the dataset are called the <code>shardkey</code>s. The <em>sharding</em> is performed by computing a deterministic hash on the shard keys (the <code>by</code> variables) for each row. The hash function produces an integer between <code>1</code> and <code>n</code>, where <code>n</code> is the number of chunks.</p>
</div>
<div id="group-by" class="section level2">
<h2>Group-by</h2>
<p><code>{disk.frame}</code> implements the <code>group_by</code> operation some caveats. In the <code>{disk.frame}</code> framework, only a set functions are supported in <code>summarize</code>. However, the user can create more custom <code>group-by</code> functions can be defined.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" title="1">flights.df <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb16-2" title="2"><span class="st">  </span><span class="kw">group_by</span>(carrier) <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># notice that hard_group_by needs to be set</span></a>
<a class="sourceLine" id="cb16-3" title="3"><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">count =</span> <span class="kw">n</span>(), <span class="dt">mean_dep_delay =</span> <span class="kw">mean</span>(dep_delay, <span class="dt">na.rm=</span>T)) <span class="op">%&gt;%</span><span class="st">  </span><span class="co"># mean follows normal R rules</span></a>
<a class="sourceLine" id="cb16-4" title="4"><span class="st">  </span>collect <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb16-5" title="5"><span class="st">  </span><span class="kw">arrange</span>(carrier)</a></code></pre></div>
</div>
<div id="restrict-input-columns-for-faster-processing" class="section level2">
<h2>Restrict input columns for faster processing</h2>
<p>One can restrict which input columns to load into memory for each chunk; this can significantly increase the speed of data processing. To restrict the input columns, use the <code>srckeep</code> function which only accepts column names as a string vector.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" title="1">flights.df <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb17-2" title="2"><span class="st">  </span><span class="kw">srckeep</span>(<span class="kw">c</span>(<span class="st">&quot;carrier&quot;</span>,<span class="st">&quot;dep_delay&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb17-3" title="3"><span class="st">  </span><span class="kw">group_by</span>(carrier) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb17-4" title="4"><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">count =</span> <span class="kw">n</span>(), <span class="dt">mean_dep_delay =</span> <span class="kw">mean</span>(dep_delay, <span class="dt">na.rm=</span>T)) <span class="op">%&gt;%</span><span class="st">  </span><span class="co"># mean follows normal R rules</span></a>
<a class="sourceLine" id="cb17-5" title="5"><span class="st">  </span>collect</a></code></pre></div>
<p>Input column restriction is one of the most critical efficiencies provided by <code>disk.frame</code>. Because the underlying format allows random access to columns (i.e. retrieve only the columns used for processing), hence one can drastically reduce the amount of data loaded into RAM for processing by keeping only those columns that are directly used to produce the results.</p>
</div>
<div id="joins" class="section level2">
<h2>Joins</h2>
<p><code>disk.frame</code> supports many dplyr joins including:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" title="1">left_join</a>
<a class="sourceLine" id="cb18-2" title="2">inner_join</a>
<a class="sourceLine" id="cb18-3" title="3">semi_join</a>
<a class="sourceLine" id="cb18-4" title="4">inner_join</a>
<a class="sourceLine" id="cb18-5" title="5">full_join <span class="co"># requires hard_group_by on both left and right</span></a></code></pre></div>
<p>In all cases, the left dataset (<code>x</code>) must be a <code>disk.frame</code>, and the right dataset (<code>y</code>) can be either a <code>disk.frame</code> or a <code>data.frame</code>. If the right dataset is a <code>disk.frame</code> and the <code>shardkey</code>s are different between the two <code>disk.frame</code>s then two expensive <code>hard</code> <code>group_by</code> operations are performed <em>eagerly</em>, one on the left <code>disk.frame</code> and one on the right <code>disk.frame</code> to perform the joins correctly.</p>
<p>However, if the right dataset is a <code>data.frame</code> then <code>hard_group_by</code>s are only performed in the case of <code>full_join</code>.</p>
<p>Note <code>disk.frame</code> does not support <code>right_join</code> the user should use <code>left_join</code> instead.</p>
<p>The below joins are performed <em>lazily</em> because <code>airlines.dt</code> is a <code>data.table</code> not a <code>disk.frame</code>:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb19-1" title="1"><span class="co"># make airlines a data.table</span></a>
<a class="sourceLine" id="cb19-2" title="2">airlines.dt &lt;-<span class="st"> </span><span class="kw">data.table</span>(airlines)</a>
<a class="sourceLine" id="cb19-3" title="3"><span class="co"># flights %&gt;% left_join(airlines, by = &quot;carrier&quot;) #</span></a>
<a class="sourceLine" id="cb19-4" title="4">flights.df <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb19-5" title="5"><span class="st">  </span><span class="kw">left_join</span>(airlines.dt, <span class="dt">by =</span><span class="st">&quot;carrier&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb19-6" title="6"><span class="st">  </span>collect <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb19-7" title="7"><span class="st">  </span>head</a></code></pre></div>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb20-1" title="1">flights.df <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb20-2" title="2"><span class="st">  </span><span class="kw">left_join</span>(airlines.dt, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;carrier&quot;</span>, <span class="st">&quot;carrier&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb20-3" title="3"><span class="st">  </span>collect <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb20-4" title="4"><span class="st">  </span>tail</a></code></pre></div>
</div>
<div id="window-functions-and-arbitrary-functions" class="section level2">
<h2>Window functions and arbitrary functions</h2>
<p><code>{disk.frame}</code> supports all <code>data.frame</code> operations, unlike Spark which can only perform those operations that Spark has implemented. Hence windowing functions like <code>min_rank</code> and <code>rank</code> are supported out of the box.</p>
<p>For the following example, we will use the <code>hard_group_by</code> which performs a group-by and also reorganises the chunks so that all records with the same <code>year</code>, <code>month</code>, and <code>day</code> end up in the same chunk. This is typically not advised, as <code>hard_group_by</code> can be slow for large datasets.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb21-1" title="1"><span class="co"># Find the most and least delayed flight each day</span></a>
<a class="sourceLine" id="cb21-2" title="2">bestworst &lt;-<span class="st"> </span>flights.df <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb21-3" title="3"><span class="st">   </span><span class="kw">srckeep</span>(<span class="kw">c</span>(<span class="st">&quot;year&quot;</span>,<span class="st">&quot;month&quot;</span>,<span class="st">&quot;day&quot;</span>, <span class="st">&quot;dep_delay&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb21-4" title="4"><span class="st">   </span><span class="kw">hard_group_by</span>(<span class="kw">c</span>(<span class="st">&quot;year&quot;</span>, <span class="st">&quot;month&quot;</span>, <span class="st">&quot;day&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb21-5" title="5"><span class="st">   </span><span class="kw">filter</span>(dep_delay <span class="op">==</span><span class="st"> </span><span class="kw">min</span>(dep_delay, <span class="dt">na.rm =</span> T) <span class="op">||</span><span class="st"> </span>dep_delay <span class="op">==</span><span class="st"> </span><span class="kw">max</span>(dep_delay, <span class="dt">na.rm =</span> T)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb21-6" title="6"><span class="st">   </span>collect</a>
<a class="sourceLine" id="cb21-7" title="7">   </a>
<a class="sourceLine" id="cb21-8" title="8">bestworst <span class="op">%&gt;%</span><span class="st"> </span>head</a></code></pre></div>
<p>another example</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb22-1" title="1">ranked &lt;-<span class="st"> </span>flights.df <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb22-2" title="2"><span class="st">  </span><span class="kw">srckeep</span>(<span class="kw">c</span>(<span class="st">&quot;year&quot;</span>,<span class="st">&quot;month&quot;</span>,<span class="st">&quot;day&quot;</span>, <span class="st">&quot;dep_delay&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb22-3" title="3"><span class="st">  </span><span class="kw">hard_group_by</span>(<span class="kw">c</span>(<span class="st">&quot;year&quot;</span>, <span class="st">&quot;month&quot;</span>, <span class="st">&quot;day&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb22-4" title="4"><span class="st">  </span><span class="kw">filter</span>(<span class="kw">min_rank</span>(<span class="kw">desc</span>(dep_delay)) <span class="op">&lt;=</span><span class="st"> </span><span class="dv">2</span> <span class="op">&amp;</span><span class="st"> </span>dep_delay <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb22-5" title="5"><span class="st">  </span>collect</a>
<a class="sourceLine" id="cb22-6" title="6"></a>
<a class="sourceLine" id="cb22-7" title="7">ranked <span class="op">%&gt;%</span><span class="st"> </span>head</a></code></pre></div>
<p>one more example</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb23-1" title="1"><span class="co"># Rank each flight within a daily</span></a>
<a class="sourceLine" id="cb23-2" title="2">ranked &lt;-<span class="st"> </span>flights.df <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb23-3" title="3"><span class="st">  </span><span class="kw">srckeep</span>(<span class="kw">c</span>(<span class="st">&quot;year&quot;</span>,<span class="st">&quot;month&quot;</span>,<span class="st">&quot;day&quot;</span>, <span class="st">&quot;dep_delay&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb23-4" title="4"><span class="st">  </span><span class="kw">chunk_group_by</span>(year, month, day) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb23-5" title="5"><span class="st">  </span><span class="kw">select</span>(dep_delay) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb23-6" title="6"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">rank =</span> <span class="kw">rank</span>(<span class="kw">desc</span>(dep_delay))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb23-7" title="7"><span class="st">  </span>collect</a>
<a class="sourceLine" id="cb23-8" title="8"></a>
<a class="sourceLine" id="cb23-9" title="9">ranked <span class="op">%&gt;%</span><span class="st"> </span>head</a></code></pre></div>
</div>
<div id="arbitrary-by-chunk-processing" class="section level2">
<h2>Arbitrary by-chunk processing</h2>
<p>One can apply arbitrary transformations to each chunk of the <code>disk.frame</code> by using the <code>delayed</code> function which evaluates lazily or the <code>map.disk.frame(lazy = F)</code> function which evaluates eagerly. For example to return the number of rows in each chunk</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb24-1" title="1">flights.df1 &lt;-<span class="st"> </span><span class="kw">delayed</span>(flights.df, <span class="op">~</span><span class="kw">nrow</span>(.x))</a>
<a class="sourceLine" id="cb24-2" title="2"><span class="kw">collect_list</span>(flights.df1) <span class="op">%&gt;%</span><span class="st"> </span>head <span class="co"># returns number of rows for each data.frame in a list</span></a></code></pre></div>
<p>and to do the same with <code>map.disk.frame</code></p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb25-1" title="1"><span class="kw">map</span>(flights.df, <span class="op">~</span><span class="kw">nrow</span>(.x), <span class="dt">lazy =</span> F) <span class="op">%&gt;%</span><span class="st"> </span>head</a></code></pre></div>
<p>The <code>map</code> function can also output the results to another disk.frame folder, e.g.</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb26-1" title="1"><span class="co"># return the first 10 rows of each chunk</span></a>
<a class="sourceLine" id="cb26-2" title="2">flights.df2 &lt;-<span class="st"> </span><span class="kw">map</span>(flights.df, <span class="op">~</span>.x[<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>,], <span class="dt">lazy =</span> F, <span class="dt">outdir =</span> <span class="kw">file.path</span>(<span class="kw">tempdir</span>(), <span class="st">&quot;tmp2&quot;</span>), <span class="dt">overwrite =</span> T)</a>
<a class="sourceLine" id="cb26-3" title="3"></a>
<a class="sourceLine" id="cb26-4" title="4">flights.df2 <span class="op">%&gt;%</span><span class="st"> </span>head</a></code></pre></div>
<p>Notice <code>{disk.frame}</code> supports the <code>purrr</code> syntax for defining a function using <code>~</code>.</p>
</div>
<div id="sampling" class="section level2">
<h2>Sampling</h2>
<p>In the <code>disk.frame</code> framework, sampling a proportion of rows within each chunk can be performed using <code>sample_frac</code>.</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb27-1" title="1">flights.df <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">sample_frac</span>(<span class="fl">0.01</span>) <span class="op">%&gt;%</span><span class="st"> </span>collect <span class="op">%&gt;%</span><span class="st"> </span>head</a></code></pre></div>
</div>
<div id="writing-data" class="section level2">
<h2>Writing Data</h2>
<p>One can output a <code>disk.frame</code> by using the <code>write_disk.frame</code> function. E.g.</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb28-1" title="1"><span class="kw">write_disk.frame</span>(flights.df, <span class="dt">outdir=</span><span class="st">&quot;out&quot;</span>)</a></code></pre></div>
<p>this will output a disk.frame to the folder “out”</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb29-1" title="1">fs<span class="op">::</span><span class="kw">dir_delete</span>(<span class="kw">file.path</span>(<span class="kw">tempdir</span>(), <span class="st">&quot;tmp_flights.df&quot;</span>))</a>
<a class="sourceLine" id="cb29-2" title="2">fs<span class="op">::</span><span class="kw">dir_delete</span>(<span class="kw">file.path</span>(<span class="kw">tempdir</span>(), <span class="st">&quot;tmp2&quot;</span>))</a>
<a class="sourceLine" id="cb29-3" title="3">fs<span class="op">::</span><span class="kw">file_delete</span>(<span class="kw">file.path</span>(<span class="kw">tempdir</span>(), <span class="st">&quot;tmp_flights.csv&quot;</span>))</a></code></pre></div>
</div>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
